{% extends "base.html" %}

{% block title %}ä»ªè¡¨ç›˜ - å¾®ä¿¡æœºå™¨äºº{% endblock %}

{% block extra_css %}
<style>
    .status-badge {
        display: inline-flex;
        align-items: center;
        gap: 8px;
        padding: 8px 20px;
        border-radius: 50px;
        font-weight: 600;
        font-size: 0.95rem;
        backdrop-filter: blur(10px);
        box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
        transition: all 0.3s ease;
    }

    .status-running {
        background: rgba(16, 185, 129, 0.2);
        color: #34d399;
        border: 1px solid rgba(16, 185, 129, 0.3);
        box-shadow: 0 0 20px rgba(16, 185, 129, 0.2);
    }

    .status-paused {
        background: rgba(245, 158, 11, 0.2);
        color: #fbbf24;
        border: 1px solid rgba(245, 158, 11, 0.3);
        box-shadow: 0 0 20px rgba(245, 158, 11, 0.2);
    }

    .status-stopped {
        background: rgba(239, 68, 68, 0.2);
        color: #f87171;
        border: 1px solid rgba(239, 68, 68, 0.3);
        box-shadow: 0 0 20px rgba(239, 68, 68, 0.2);
    }

    .cards {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
        gap: 24px;
        margin-bottom: 40px;
    }

    .card-icon {
        font-size: 2.5rem;
        margin-bottom: 16px;
        background: var(--accent-gradient);
        background-clip: text;
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        filter: drop-shadow(0 4px 10px rgba(56, 189, 248, 0.3));
    }

    .card-value {
        font-size: 2.5rem;
        font-weight: 800;
        margin-bottom: 8px;
        color: var(--text-primary);
        letter-spacing: -1px;
        text-shadow: 0 0 20px rgba(255, 255, 255, 0.1);
    }

    .card-label {
        color: var(--text-secondary);
        font-size: 0.95rem;
        font-weight: 500;
        text-transform: uppercase;
        letter-spacing: 1px;
    }

    .control-panel {
        background: rgba(15, 23, 42, 0.4);
        border: 1px solid var(--card-border);
        border-radius: 24px;
        padding: 32px;
        backdrop-filter: blur(var(--glass-blur));
    }

    .controls-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
        gap: 20px;
        margin-top: 20px;
    }

    .btn-start {
        background: linear-gradient(135deg, #10b981 0%, #059669 100%);
        color: white;
    }

    .btn-stop {
        background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
        color: white;
    }

    .btn-pause {
        background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);
        color: white;
    }

    .btn-resume {
        background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);
        color: white;
    }

    .btn-refresh {
        background: rgba(255, 255, 255, 0.05);
        color: var(--text-primary);
        border: 1px solid var(--card-border);
    }

    .btn-refresh:hover {
        background: rgba(255, 255, 255, 0.1);
        border-color: rgba(255, 255, 255, 0.2);
    }

    .divider {
        height: 1px;
        background: var(--card-border);
        margin: 30px 0;
    }
</style>
{% endblock %}

{% block content %}
<div class="page-header">
    <div>
        <h1 class="page-title">ä»ªè¡¨ç›˜</h1>
        <div class="page-subtitle">ç³»ç»Ÿå®æ—¶ç›‘æ§ä¸æ§åˆ¶ä¸­å¿ƒ</div>
    </div>
    <span id="status-badge" class="status-badge status-stopped">
        <span class="status-dot">â—</span> <span>è·å–çŠ¶æ€ä¸­...</span>
    </span>
</div>

<div class="cards">
    <div class="card">
        <div class="card-icon">â±ï¸</div>
        <div class="card-value" id="uptime">{{ uptime }}</div>
        <div class="card-label">è¿è¡Œæ—¶é•¿</div>
    </div>
    <div class="card">
        <div class="card-icon">ğŸ’¬</div>
        <div class="card-value" id="today-replies">{{ today_replies }}</div>
        <div class="card-label">ä»Šæ—¥å›å¤</div>
    </div>
    <div class="card">
        <div class="card-icon">âš¡</div>
        <div class="card-value" id="today-tokens">{{ today_tokens | number_format }}</div>
        <div class="card-label">ä»Šæ—¥ Token</div>
    </div>
    <div class="card">
        <div class="card-icon">ğŸ“Š</div>
        <div class="card-value" id="total-replies">{{ total_replies }}</div>
        <div class="card-label">æ€»å›å¤æ•°</div>
    </div>
</div>

<div class="control-panel">
    <h3 style="font-size: 1.25rem; font-weight: 700; margin-bottom: 24px;">å¿«æ·æ§åˆ¶</h3>

    <div class="controls-grid">
        <button id="btn-start" class="btn btn-start" onclick="controlBot('start')">
            ğŸš€ å¯åŠ¨æœºå™¨äºº
        </button>
        <button id="btn-stop" class="btn btn-stop" onclick="controlBot('stop')">
            ğŸ›‘ åœæ­¢è¿è¡Œ
        </button>
        <button id="btn-restart" class="btn btn-refresh" onclick="controlBot('restart')">
            â™»ï¸ é‡å¯è¿›ç¨‹
        </button>
    </div>

    <div class="divider"></div>

    <div class="controls-grid">
        <button id="btn-pause" class="btn btn-pause" onclick="pauseBot()">
            â¸ï¸ æš‚åœå›å¤
        </button>
        <button id="btn-resume" class="btn btn-resume" onclick="resumeBot()">
            â–¶ï¸ æ¢å¤å›å¤
        </button>
        <button class="btn btn-refresh" onclick="refreshStatus()">
            ğŸ”„ åˆ·æ–°çŠ¶æ€
        </button>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    // ç”¨äºåŠ¨ç”»çš„å‰å€¼å­˜å‚¨
    let prevValues = {
        'today-replies': 0,
        'today-tokens': 0,
        'total-replies': 0
    };

    // é¡µé¢åŠ è½½ååˆå§‹åŒ–å‰å€¼
    document.addEventListener('DOMContentLoaded', function () {
        const repliesEl = document.getElementById('today-replies');
        const tokensEl = document.getElementById('today-tokens');
        const totalEl = document.getElementById('total-replies');

        prevValues['today-replies'] = parseInt(repliesEl.textContent) || 0;
        prevValues['today-tokens'] = parseInt(tokensEl.textContent.replace(/,/g, '')) || 0;
        prevValues['total-replies'] = parseInt(totalEl.textContent) || 0;
    });

    async function controlBot(action) {
        if (action === 'stop' && !confirm('ç¡®å®šè¦åœæ­¢æœºå™¨äººè¿›ç¨‹å—ï¼Ÿ')) return;
        if (action === 'restart' && !confirm('ç¡®å®šè¦é‡å¯æœºå™¨äººè¿›ç¨‹å—ï¼Ÿ')) return;

        showLoader();
        try {
            const resp = await fetch('/api/' + action, { method: 'POST' });
            const data = await resp.json();
            showToast(data.message, data.success ? 'success' : 'error');
            refreshStatus();
        } catch (e) {
            showToast('æ“ä½œå¤±è´¥: ' + e, 'error');
        } finally {
            hideLoader();
        }
    }

    async function pauseBot() {
        showLoader();
        try {
            const resp = await fetch('/api/pause', { method: 'POST' });
            const data = await resp.json();
            if (resp.ok) {
                showToast('æœºå™¨äººå·²æš‚åœ', 'warning');
                refreshStatus();
            }
        } catch (e) {
            showToast('æš‚åœå¤±è´¥', 'error');
        } finally {
            hideLoader();
        }
    }

    async function resumeBot() {
        showLoader();
        try {
            const resp = await fetch('/api/resume', { method: 'POST' });
            const data = await resp.json();
            if (resp.ok) {
                showToast('æœºå™¨äººå·²æ¢å¤è¿è¡Œ', 'success');
                refreshStatus();
            }
        } catch (e) {
            showToast('æ¢å¤å¤±è´¥', 'error');
        } finally {
            hideLoader();
        }
    }

    async function refreshStatus() {
        try {
            const resp = await fetch('/api/status');
            const data = await resp.json();

            // æ›´æ–°è¿è¡Œæ—¶é•¿
            document.getElementById('uptime').textContent = data.uptime;

            // è·å–å…ƒç´ 
            const repliesEl = document.getElementById('today-replies');
            const tokensEl = document.getElementById('today-tokens');
            const totalEl = document.getElementById('total-replies');

            // åŠ¨ç”»æ›´æ–°æ•°å€¼
            if (data.today_replies !== prevValues['today-replies']) {
                animateValue(repliesEl, prevValues['today-replies'], data.today_replies);
                prevValues['today-replies'] = data.today_replies;
            }

            if (data.today_tokens !== prevValues['today-tokens']) {
                animateValue(tokensEl, prevValues['today-tokens'], data.today_tokens);
                prevValues['today-tokens'] = data.today_tokens;
            }

            if (data.total_replies !== prevValues['total-replies']) {
                animateValue(totalEl, prevValues['total-replies'], data.total_replies);
                prevValues['total-replies'] = data.total_replies;
            }

            // è·å–æŒ‰é’®å…ƒç´ 
            const badge = document.getElementById('status-badge');
            const btnStart = document.getElementById('btn-start');
            const btnStop = document.getElementById('btn-stop');
            const btnRestart = document.getElementById('btn-restart');
            const btnPause = document.getElementById('btn-pause');
            const btnResume = document.getElementById('btn-resume');

            if (!data.running) {
                // åœæ­¢çŠ¶æ€
                badge.className = 'status-badge status-stopped';
                badge.innerHTML = '<span class="status-dot">â—</span> å·²åœæ­¢';
                btnStart.disabled = false;
                btnStop.disabled = true;
                btnRestart.disabled = true;
                btnPause.disabled = true;
                btnResume.disabled = true;
            } else {
                // è¿è¡ŒçŠ¶æ€
                btnStart.disabled = true;
                btnStop.disabled = false;
                btnRestart.disabled = false;

                if (data.is_paused) {
                    badge.className = 'status-badge status-paused';
                    badge.innerHTML = '<span class="status-dot status-pulse">â—</span> å·²æš‚åœ';
                    btnPause.disabled = true;
                    btnResume.disabled = false;
                } else {
                    badge.className = 'status-badge status-running';
                    badge.innerHTML = '<span class="status-dot status-pulse">â—</span> è¿è¡Œä¸­';
                    btnPause.disabled = false;
                    btnResume.disabled = true;
                }
            }
        } catch (e) {
            console.error('åˆ·æ–°å¤±è´¥:', e);
        }
    }

    // åˆå§‹åŠ è½½
    refreshStatus();
    // æ¯ 5 ç§’è‡ªåŠ¨åˆ·æ–°
    setInterval(refreshStatus, 5000);
</script>
{% endblock %}