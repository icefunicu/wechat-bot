{% extends "base.html" %}

{% block title %}è®¾ç½® - å¾®ä¿¡æœºå™¨äºº{% endblock %}

{% block extra_css %}
<style>
    /* å®¹å™¨ä¸å¸ƒå±€ */
    .settings-container {
        max-width: 1000px;
        margin: 0 auto;
        padding-bottom: 100px;
    }

    .section-title {
        font-size: 1.25rem;
        font-weight: 600;
        margin: 32px 0 16px;
        color: var(--text-primary);
        display: flex;
        align-items: center;
        gap: 8px;
    }

    .section-desc {
        font-size: 0.9rem;
        color: var(--text-secondary);
        margin-bottom: 24px;
        background: rgba(59, 130, 246, 0.1);
        border-left: 3px solid var(--accent-primary);
        padding: 12px 16px;
        border-radius: 0 8px 8px 0;
    }

    /* å¡ç‰‡æ ·å¼ */
    .glass-card {
        background: rgba(30, 41, 59, 0.7);
        backdrop-filter: blur(20px);
        border: 1px solid rgba(255, 255, 255, 0.1);
        border-radius: 16px;
        padding: 24px;
        margin-bottom: 24px;
        box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
    }

    /* è¡¨å•å…ƒç´  common */
    .form-group {
        margin-bottom: 20px;
    }

    .form-label {
        display: block;
        font-size: 0.9rem;
        font-weight: 500;
        color: var(--text-secondary);
        margin-bottom: 8px;
    }

    .form-control {
        width: 100%;
        background: rgba(0, 0, 0, 0.2);
        border: 1px solid rgba(255, 255, 255, 0.1);
        border-radius: 12px;
        padding: 12px 16px;
        color: var(--text-primary);
        font-family: inherit;
        font-size: 0.95rem;
        transition: all 0.2s;
    }

    .form-control:focus {
        outline: none;
        border-color: var(--accent-primary);
        box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.2);
        background: rgba(0, 0, 0, 0.3);
    }

    .form-select {
        appearance: none;
        background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 20 20'%3e%3cpath stroke='%2394a3b8' stroke-linecap='round' stroke-linejoin='round' stroke-width='1.5' d='M6 8l4 4 4-4'/%3e%3c/svg%3e");
        background-position: right 0.5rem center;
        background-repeat: no-repeat;
        background-size: 1.5em 1.5em;
        padding-right: 2.5rem;
    }

    /* Toggle Switch */
    .toggle-switch {
        position: relative;
        display: inline-flex;
        align-items: center;
        cursor: pointer;
        user-select: none;
    }

    .toggle-input {
        position: absolute;
        opacity: 0;
        width: 0;
        height: 0;
    }

    .toggle-track {
        width: 44px;
        height: 24px;
        background-color: rgba(255, 255, 255, 0.1);
        border-radius: 34px;
        transition: 0.3s;
        position: relative;
        border: 1px solid rgba(255, 255, 255, 0.1);
    }

    .toggle-thumb {
        position: absolute;
        top: 2px;
        left: 2px;
        width: 18px;
        height: 18px;
        background-color: white;
        border-radius: 50%;
        transition: 0.3s;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
    }

    .toggle-input:checked+.toggle-track {
        background-color: var(--accent-primary);
        border-color: var(--accent-primary);
    }

    .toggle-input:checked+.toggle-track .toggle-thumb {
        transform: translateX(20px);
    }

    .toggle-label {
        margin-left: 12px;
        font-size: 0.95rem;
        color: var(--text-primary);
    }

    /* åº•éƒ¨æ“ä½œæ  */
    .action-bar {
        position: fixed;
        bottom: 20px;
        right: 20px;
        /* width: auto;  removed to avoid conflict with inline style if any, but inline usually wins */
        background: rgba(15, 23, 42, 0.9);
        backdrop-filter: blur(12px);
        border: 1px solid rgba(255, 255, 255, 0.1);
        border-radius: 12px;
        padding: 12px 24px;
        display: flex;
        align-items: center;
        gap: 16px;
        z-index: 1000;
        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5);
    }

    /* Sidebar Layout */
    .settings-layout {
        display: flex;
        gap: 30px;
        align-items: flex-start;
        min-height: calc(100vh - 100px);
    }

    .settings-sidebar {
        width: 260px;
        flex-shrink: 0;
        position: sticky;
        top: 20px;
        background: rgba(255, 255, 255, 0.03);
        border: 1px solid rgba(255, 255, 255, 0.05);
        border-radius: 12px;
        padding: 12px;
        backdrop-filter: blur(10px);
    }

    .nav-item {
        display: block;
        padding: 12px 16px;
        color: var(--text-secondary);
        border-radius: 8px;
        cursor: pointer;
        transition: all 0.2s;
        margin-bottom: 4px;
        font-size: 0.95rem;
        display: flex;
        align-items: center;
        gap: 8px;
    }

    .nav-item:hover {
        background: rgba(255, 255, 255, 0.05);
        color: var(--text-primary);
    }

    .nav-item.active {
        background: var(--accent-gradient);
        color: white;
        font-weight: 500;
        box-shadow: 0 4px 12px rgba(59, 130, 246, 0.2);
    }

    .settings-content {
        flex: 1;
        min-width: 0;
        /* Prevent overflow */
    }

    /* Tabs */
    .tab-pane {
        display: none;
        animation: fadeIn 0.3s ease;
    }

    .tab-pane.active {
        display: block;
    }

    @keyframes fadeIn {
        from {
            opacity: 0;
            transform: translateY(5px);
        }

        to {
            opacity: 1;
            transform: translateY(0);
        }
    }

    /* Reuse existing styles */
    .status-text {
        color: var(--text-secondary);
        font-size: 0.9rem;
        display: flex;
        align-items: center;
        gap: 6px;
    }

    .btn-primary {
        background: var(--accent-gradient);
        color: white;
        border: none;
        padding: 8px 20px;
        border-radius: 8px;
        font-weight: 500;
        cursor: pointer;
        box-shadow: 0 4px 12px rgba(59, 130, 246, 0.3);
        transition: all 0.2s;
    }

    .btn-primary:hover {
        transform: translateY(-1px);
        box-shadow: 0 6px 16px rgba(59, 130, 246, 0.4);
    }

    .btn-reset {
        background: transparent;
        border: 1px solid rgba(255, 255, 255, 0.2);
        color: white;
        padding: 8px 16px;
        border-radius: 8px;
        cursor: pointer;
        transition: all 0.2s;
    }

    .btn-reset:hover {
        background: rgba(255, 255, 255, 0.1);
    }

    /* JSON Editor Override */
    .json-editor {
        font-family: 'JetBrains Mono', monospace;
        font-size: 0.85rem;
        min-height: 120px;
    }

    .config-group-title {
        display: none;
        /* Hidden in tab view as tab name serves as title */
    }

    .config-row {
        display: grid;
        grid-template-columns: 200px 1fr;
        gap: 24px;
        margin-bottom: 24px;
        align-items: start;
        padding-bottom: 20px;
        border-bottom: 1px solid rgba(255, 255, 255, 0.03);
    }

    .config-row:last-child {
        border-bottom: none;
    }

    .config-key {
        font-size: 0.9rem;
        color: var(--text-secondary);
        padding-top: 6px;
        /* align with input */
    }

    .config-desc {
        font-size: 0.8rem;
        color: rgba(255, 255, 255, 0.3);
        margin-top: 4px;
        line-height: 1.4;
    }
</style>
{% endblock %}

{% block content %}
<div class="settings-container">
    <div class="page-header">
        <div>
            <h1 class="page-title">ç³»ç»Ÿé…ç½®</h1>
            <div class="page-subtitle">åŠ¨æ€è°ƒæ•´æ¨¡å‹å‚æ•°ä¸æœºå™¨äººè¡Œä¸ºï¼Œé…ç½®å³æ—¶ç”Ÿæ•ˆã€‚</div>
        </div>
    </div>

    <!-- Sidebar Layout -->
    <div class="settings-layout">
        <!-- Left Sidebar -->
        <div class="settings-sidebar" id="settings-sidebar">
            <div class="nav-item active" onclick="switchTab('model')" data-tab="model">ğŸ¤– æ¨¡å‹é…ç½®</div>
            <!-- Bot config tabs injected via JS -->
        </div>

        <!-- Right Content -->
        <div class="settings-content">

            <!-- Tab: Model Configuration -->
            <div id="tab-model" class="tab-pane active">
                <div class="glass-card">
                    <div class="section-title" style="margin-bottom: 20px;">ğŸ¤– æ¨¡å‹é…ç½® (Model API)</div>
                    <div class="section-desc" style="margin-bottom: 20px;">
                        é€‰æ‹© AI æ¨¡å‹ä¾›åº”å•†ï¼Œæˆ–è‡ªå®šä¹‰ API æ¥å£ã€‚ä¿®æ”¹æ­¤å¤„å°†ç›´æ¥å½±å“æœºå™¨äººçš„å›å¤èƒ½åŠ›ã€‚
                    </div>

                    <div class="form-group">
                        <label class="form-label">ä¾›åº”å•†é¢„è®¾ (Provider Preset)</label>
                        <select id="preset-select" class="form-control form-select">
                            <option value="custom">è‡ªå®šä¹‰ (Custom)</option>
                            <!-- JS Populated -->
                        </select>
                    </div>

                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px;">
                        <div class="form-group" style="grid-column: 1 / -1;">
                            <label class="form-label">æ¥å£åœ°å€ (Base URL)</label>
                            <input type="text" id="api-base-url" class="form-control"
                                placeholder="https://api.openai.com/v1">
                        </div>

                        <div class="form-group">
                            <label class="form-label">API å¯†é’¥ (API Key)</label>
                            <input type="password" id="api-key" class="form-control" placeholder="sk-...">
                            <div class="config-desc">ä¸ºäº†å®‰å…¨ï¼Œå¯†é’¥é»˜è®¤éšè—ã€‚å¦‚éœ€ä¿®æ”¹è¯·ç›´æ¥è¾“å…¥ã€‚</div>
                        </div>

                        <div class="form-group">
                            <label class="form-label">æ¨¡å‹åç§° (Model Name)</label>
                            <input type="text" id="api-model" class="form-control" placeholder="gpt-4o">
                        </div>

                        <div class="form-group">
                            <label class="form-label">æ¸©åº¦ (Temperature)</label>
                            <div style="display: flex; gap: 12px; align-items: center;">
                                <input type="range" id="api-temp-range" min="0" max="2" step="0.1" style="flex:1">
                                <input type="number" id="api-temperature" class="form-control" style="width: 80px;"
                                    min="0" max="2" step="0.1">
                            </div>
                        </div>
                        <div class="form-group">
                            <label class="form-label">æœ€å¤§ Token (Max Tokens)</label>
                            <input type="number" id="api-max-tokens" class="form-control" placeholder="512">
                        </div>
                    </div>
                </div>


                <!-- Bot Config Tabs (Injected by JS) -->

            </div> <!-- End Tab Model -->
        </div> <!-- End Settings Content -->
    </div> <!-- End Settings Layout -->

    <!-- Global Action Bar (Floating at bottom-right) -->
    <div class="action-bar">
        <div class="status-text" id="status-msg">
            <span>âœ…</span> å‡†å¤‡å°±ç»ª
        </div>
        <button class="btn btn-reset" onclick="initPage()">
            ğŸ”„ é‡ç½®
        </button>
        <button class="btn btn-primary" onclick="saveConfig()">
            ğŸ’¾ ä¿å­˜é…ç½®
        </button>
    </div>

</div> <!-- End Settings Container -->
{% endblock %}

{% block scripts %}
<script>
    let globalDefaults = {};
    let globalOverrides = {};
    let globalPresets = [];

    // Config Group Definitions
    const groupMap = {
        'åŸºç¡€': { icon: 'ğŸ“', keys: ['self_name', 'system_prompt', 'reply_suffix', 'reply_quote_mode'] },
        'åŠŸèƒ½': { icon: 'âœ¨', keys: ['voice_to_text', 'personalization_enabled', 'remember_facts_enabled', 'emotion_detection_enabled', 'stream_reply', 'natural_split_enabled'] },
        'æ§åˆ¶': { icon: 'ğŸ›¡ï¸', keys: ['filter_mute', 'ignore_official', 'whitelist_enabled', 'whitelist', 'control_commands_enabled', 'group_reply_only_when_at'] },
        'é«˜çº§': { icon: 'âš™ï¸', keys: ['poll_interval_min_sec', 'history_max_chats', 'memory_context_limit', 'max_concurrency', 'reply_chunk_size'] }
    };

    // é¡µé¢åˆå§‹åŒ–
    document.addEventListener('DOMContentLoaded', initPage);

    async function initPage() {
        try {
            const resp = await fetch('/api/config');
            const data = await resp.json();

            globalDefaults = data.defaults || {};
            globalOverrides = data.overrides || {};
            globalPresets = data.presets || [];

            initModelSection();
            renderBotConfig();

            showToast('æ•°æ®åŠ è½½å®Œæˆ', 'success');
        } catch (e) {
            console.error(e);
            showToast('åŠ è½½å¤±è´¥: ' + e.message, 'error');
        }
    }

    function switchTab(tabId) {
        // 1. Update Sidebar
        document.querySelectorAll('.nav-item').forEach(el => {
            el.classList.toggle('active', el.dataset.tab === tabId);
        });

        // 2. Update Content
        document.querySelectorAll('.tab-pane').forEach(el => {
            el.classList.toggle('active', el.id === 'tab-' + tabId);
        });

        // Scroll to top
        window.scrollTo({ top: 0, behavior: 'smooth' });
    }

    // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    // 1. æ¨¡å‹é…ç½®
    // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

    function initModelSection() {
        // Tag sidebar item
        const modelNav = document.querySelector('.nav-item[onclick="switchTab(\'model\')"]');
        if (modelNav) modelNav.dataset.tab = 'model';

        const presetSelect = document.getElementById('preset-select');
        presetSelect.innerHTML = '<option value="custom">ğŸ› ï¸ è‡ªå®šä¹‰ (Custom)</option>';

        globalPresets.forEach(p => {
            const opt = document.createElement('option');
            opt.value = p.name;
            opt.textContent = `ğŸ“¦ ${p.name} (${p.alias || ''})`;
            presetSelect.appendChild(opt);
        });

        presetSelect.onchange = onPresetChange;

        // Bind Range
        const range = document.getElementById('api-temp-range');
        const num = document.getElementById('api-temperature');
        if (range && num) {
            range.oninput = () => num.value = range.value;
            num.oninput = () => range.value = num.value;
        }

        // Fill Values
        const currentApi = { ...globalDefaults.api, ...(globalOverrides.api || {}) };
        document.getElementById('api-base-url').value = currentApi.base_url || '';
        document.getElementById('api-model').value = currentApi.model || '';
        if (document.getElementById('api-temperature')) document.getElementById('api-temperature').value = currentApi.temperature ?? 0.7;
        if (range) range.value = currentApi.temperature ?? 0.7;
        document.getElementById('api-max-tokens').value = currentApi.max_tokens ?? 512;

        // Match Preset
        const match = globalPresets.find(p => p.base_url === currentApi.base_url);
        if (match) presetSelect.value = match.name;
    }

    function onPresetChange(e) {
        const val = e.target.value;
        if (val === 'custom') return;
        const preset = globalPresets.find(p => p.name === val);
        if (preset) {
            document.getElementById('api-base-url').value = preset.base_url;
            document.getElementById('api-model').value = preset.model;
            document.getElementById('api-key').value = '';
            document.getElementById('api-key').placeholder = `è¯·è¾“å…¥ ${preset.name} Key`;
            showToast(`å·²åŠ è½½ ${preset.name}`, 'success');
        }
    }

    // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    // 2. Bot é…ç½®ç”Ÿæˆ (Dynamic Sidebar & Tabs)
    // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

    function renderBotConfig() {
        const sidebar = document.getElementById('settings-sidebar');
        const content = document.querySelector('.settings-content'); // Container
        const botDefaults = globalDefaults.bot || {};
        const botOverrides = globalOverrides.bot || {};

        // 1. Identify "Other" keys
        const usedKeys = new Set(Object.values(groupMap).flatMap(g => g.keys));
        const allKeys = Object.keys(botDefaults);
        const otherKeys = allKeys.filter(k => !usedKeys.has(k) && !k.startsWith('_'));

        if (otherKeys.length > 0) {
            groupMap['å…¶ä»–'] = { icon: 'ğŸ“¦', keys: otherKeys };
        }

        // 2. Clear previous dynamic items (keep first static item 'Model')
        // We will append new items
        // Remove old dynamic tabs if any? Structure is clean on init.

        const existingTabs = content.querySelectorAll('.tab-pane[id^="tab-bot-"]');
        existingTabs.forEach(e => e.remove());

        const existingNavs = sidebar.querySelectorAll('.nav-item[data-dynamic="true"]');
        existingNavs.forEach(e => e.remove());

        // 3. Generate Sidebar & Tabs
        let index = 0;
        for (const [groupName, groupData] of Object.entries(groupMap)) {
            const tabId = 'bot-' + index;

            // A. Sidebar Item
            const nav = document.createElement('div');
            nav.className = 'nav-item';
            nav.innerHTML = `${groupData.icon} ${groupName}è®¾ç½®`;
            nav.onclick = () => switchTab(tabId);
            nav.dataset.tab = tabId;
            nav.dataset.dynamic = "true";
            sidebar.appendChild(nav);

            // B. Tab Pane
            const pane = document.createElement('div');
            pane.id = 'tab-' + tabId;
            pane.className = 'tab-pane';

            // Tab Header
            const header = document.createElement('div');
            header.innerHTML = `<h2 class="section-title">${groupData.icon} ${groupName}é…ç½®</h2>
                                <div class="section-desc">é…ç½®${groupName}ç›¸å…³çš„è¿è¡Œå‚æ•°ã€‚</div>`;
            pane.appendChild(header);

            // Card Container
            const card = document.createElement('div');
            card.className = 'glass-card';

            let hasContent = false;
            groupData.keys.forEach(key => {
                if (!(key in botDefaults)) return;
                hasContent = true;

                const val = botDefaults[key];
                const initialVal = botOverrides[key] !== undefined ? botOverrides[key] : val;

                const row = document.createElement('div');
                row.className = 'config-row';

                // Label
                const labelDiv = document.createElement('div');
                labelDiv.className = 'config-key';
                labelDiv.innerHTML = `<div>${key}</div><div class="config-desc">${getDesc(key)}</div>`;
                row.appendChild(labelDiv);

                // Control
                let input;
                if (typeof val === 'boolean') {
                    // Switch
                    const wrapper = document.createElement('label');
                    wrapper.className = 'toggle-switch';

                    const inputEl = document.createElement('input');
                    inputEl.type = 'checkbox';
                    inputEl.className = 'toggle-input';
                    inputEl.checked = !!initialVal;
                    inputEl.dataset.key = key;
                    inputEl.dataset.type = 'boolean';

                    const track = document.createElement('div');
                    track.className = 'toggle-track';
                    track.innerHTML = '<div class="toggle-thumb"></div>';

                    const labelSpan = document.createElement('span');
                    labelSpan.className = 'toggle-label';
                    labelSpan.textContent = initialVal ? 'å·²å¯ç”¨' : 'å·²ç¦ç”¨';

                    wrapper.appendChild(inputEl);
                    wrapper.appendChild(track);
                    wrapper.appendChild(labelSpan);

                    inputEl.addEventListener('change', (e) => {
                        labelSpan.textContent = e.target.checked ? 'å·²å¯ç”¨' : 'å·²ç¦ç”¨';
                    });
                    input = wrapper;
                } else if (typeof val === 'number') {
                    input = document.createElement('input');
                    input.type = 'number';
                    input.className = 'form-control';
                    input.value = initialVal === null ? '' : initialVal;
                    input.dataset.key = key;
                    input.dataset.type = key.includes('float') || key.includes('sec') ? 'float' : 'int';
                } else if (Array.isArray(val)) {
                    input = document.createElement('input');
                    input.className = 'form-control';
                    input.value = JSON.stringify(initialVal).replace(/^\[|\]$/g, '');
                    input.placeholder = '"Item 1", "Item 2"';
                    input.dataset.key = key;
                    input.dataset.type = 'array';
                } else if (typeof val === 'object' && val !== null) {
                    input = document.createElement('textarea');
                    input.className = 'form-control json-editor';
                    input.value = JSON.stringify(initialVal, null, 2);
                    input.dataset.key = key;
                    input.dataset.type = 'json';
                } else {
                    const strVal = val === null ? '' : String(val);
                    if (strVal.length > 50 || key === 'system_prompt') {
                        input = document.createElement('textarea');
                        input.className = 'form-control';
                        input.rows = 5;
                        input.value = initialVal === null ? '' : initialVal;
                    } else {
                        input = document.createElement('input');
                        input.type = 'text';
                        input.className = 'form-control';
                        input.value = initialVal === null ? '' : initialVal;
                    }
                    input.dataset.key = key;
                    input.dataset.type = 'string';
                }

                row.appendChild(input);
                card.appendChild(row);
            });

            if (hasContent) {
                pane.appendChild(card);
                content.appendChild(pane);
            }
            index++;
        }
    }

    function getDesc(key) {
        const descs = {
            // åŸºç¡€è®¾ç½®
            'self_name': 'æœºå™¨äººæ˜µç§°ï¼Œç”¨äºç¾¤èŠä¸­è¯†åˆ«æ˜¯å¦è¢« @ (Call sign in groups)',
            'system_prompt': 'ç³»ç»Ÿæ ¸å¿ƒæç¤ºè¯ï¼Œå®šä¹‰äººè®¾ã€è¯­æ°”ä¸å›å¤è§„åˆ™ (System Instruction)',
            'system_prompt_overrides': 'é’ˆå¯¹ç‰¹å®šä¼šè¯çš„ä¸“ç”¨æç¤ºè¯è¦†ç›– (Session specific prompts)',

            // å›å¤æ ¼å¼
            'reply_suffix': 'æ¯æ¡å›å¤æœ«å°¾è‡ªåŠ¨è¿½åŠ çš„æ–‡æœ¬ (Suffix appended to replies)',
            'emoji_policy': 'Emoji å¤„ç†ç­–ç•¥ï¼šmixed(ä¿ç•™)ã€strip(å»é™¤)ã€wechat(è½¬ä¹‰) (Emoji handling)',
            'emoji_replacements': 'è‡ªå®šä¹‰ Emoji æ–‡æœ¬æ›¿æ¢è¡¨ (Custom emoji mapping)',

            // æ¶ˆæ¯å¼•ç”¨
            'reply_quote_mode': 'å¼•ç”¨æ¨¡å¼ï¼šwechat(åŸç”Ÿå¼•ç”¨)ã€text(æ–‡æœ¬æ¨¡æ‹Ÿ)ã€none(ä¸å¼•ç”¨) (Quote mode)',
            'reply_quote_template': 'æ–‡æœ¬å¼•ç”¨æ—¶çš„æ ¼å¼æ¨¡æ¿ (Text quote template)',
            'reply_quote_max_chars': 'å¼•ç”¨æ–‡æœ¬çš„æœ€å¤§é•¿åº¦ï¼Œ0 ä¸ºä¸é™åˆ¶ (Max quote length)',
            'reply_quote_timeout_sec': 'å¾®ä¿¡åŸç”Ÿå¼•ç”¨æ“ä½œçš„è¶…æ—¶æ—¶é—´ (Native quote timeout)',
            'reply_quote_fallback_to_text': 'åŸç”Ÿå¼•ç”¨å¤±è´¥æ—¶æ˜¯å¦è‡ªåŠ¨é™çº§ä¸ºæ–‡æœ¬å¼•ç”¨ (Fallback to text quote)',

            // è¯­éŸ³å¤„ç†
            'voice_to_text': 'æ˜¯å¦è‡ªåŠ¨å°†æ”¶åˆ°çš„è¯­éŸ³è½¬æ¢ä¸ºæ–‡å­— (Convert voice to text)',
            'voice_to_text_fail_reply': 'è¯­éŸ³è½¬å†™å¤±è´¥æ—¶å‘é€çš„æç¤ºï¼Œç•™ç©ºåˆ™å¿½ç•¥ (Reply when transcription fails)',

            // è®°å¿†ç³»ç»Ÿ
            'memory_db_path': 'èŠå¤©è®°å½•æ•°æ®åº“æ–‡ä»¶è·¯å¾„ (Database path)',
            'memory_context_limit': 'å‘é€ç»™ AI çš„å†å²æ¶ˆæ¯æ¡æ•°é™åˆ¶ (Chat history context limit)',
            'memory_ttl_sec': 'è®°å¿†åº“ä¿ç•™æ—¶é—´(ç§’)ï¼ŒNone ä¸ºæ°¸ä¹… (Memory TTL)',
            'memory_cleanup_interval_sec': 'è¿‡æœŸè®°å¿†æ¸…ç†æ£€æŸ¥é—´éš”(ç§’) (Cleanup interval)',
            'memory_seed_on_first_reply': 'é¦–æ¬¡å›å¤æ—¶æ˜¯å¦è‡ªåŠ¨æŠ“å–è¿‘æœŸå†å²è®°å½• (Fetch history on first reply)',
            'memory_seed_limit': 'é¦–æ¬¡æŠ“å–å†å²è®°å½•çš„æœ€å¤§æ¡æ•° (Max history fetch count)',
            'memory_seed_load_more': 'é¦–æ¬¡åŠ è½½æ—¶é¢å¤–å‘ä¸Šæ»šåŠ¨çš„æ¬¡æ•° (Scroll up count)',
            'memory_seed_load_more_interval_sec': 'æ»šåŠ¨åŠ è½½å†å²çš„é—´éš”æ—¶é—´ (Scroll interval)',
            'memory_seed_group': 'æ˜¯å¦åœ¨ç¾¤èŠä¸­ä¹Ÿå¯ç”¨é¦–æ¬¡å†å²æŠ“å– (Enable history fetch in groups)',

            // ä¸Šä¸‹æ–‡ç®¡ç†
            'context_rounds': 'å†…å­˜ä¸­ä¿æŒçš„å¯¹è¯è½®æ•°ä¸Šé™ (Context rounds in memory)',
            'context_max_tokens': 'ä¸Šä¸‹æ–‡æœ€å¤§ Token æ•°é™åˆ¶ (Max context tokens)',
            'history_max_chats': 'å†…å­˜ä¸­æœ€å¤šåŒæ—¶æ´»è·ƒçš„ä¼šè¯æ•° (Max active chats)',
            'history_ttl_sec': 'å†…å­˜ä¸­ä¼šè¯å¯¹è±¡çš„è¿‡æœŸæ—¶é—´(ç§’) (Session object TTL)',
            'history_log_interval_sec': 'å†å²è®°å½•ç»Ÿè®¡æ—¥å¿—çš„è¾“å‡ºé—´éš” (Stats logging interval)',

            // è½®è¯¢ä¸å»¶è¿Ÿ
            'poll_interval_sec': 'æ¶ˆæ¯æ£€æŸ¥çš„åŸºç¡€é—´éš”(ç§’) (Base poll interval)',
            'poll_interval_min_sec': 'è‡ªåŠ¨è°ƒæ•´çš„æœ€å°è½®è¯¢é—´éš”(ç§’) (Min poll interval)',
            'poll_interval_max_sec': 'è‡ªåŠ¨è°ƒæ•´çš„æœ€å¤§è½®è¯¢é—´éš”(ç§’) (Max poll interval)',
            'poll_interval_backoff_factor': 'æ— æ¶ˆæ¯æ—¶çš„è½®è¯¢é—´éš”å¢é•¿ç³»æ•° (Backoff factor)',
            'min_reply_interval_sec': 'ä¸¤æ¬¡å›å¤ä¹‹é—´çš„æœ€å°é—´éš”(ç§’) (Min reply interval)',
            'random_delay_range_sec': 'å›å¤å‰çš„éšæœºæ¨¡æ‹Ÿæ€è€ƒæ—¶é—´ [min, max] (Random thinking delay)',

            // æ¶ˆæ¯åˆå¹¶
            'merge_user_messages_sec': 'å¤šæ¡è¿ç»­æ¶ˆæ¯çš„åˆå¹¶ç­‰å¾…çª—å£(ç§’) (Message merge window)',
            'merge_user_messages_max_wait_sec': 'åˆå¹¶æ¶ˆæ¯çš„æœ€é•¿å¼ºåˆ¶ç­‰å¾…æ—¶é—´(ç§’) (Max merge wait)',

            // å›å¤å‘é€
            'reply_chunk_size': 'å•æ¬¡å‘é€çš„æœ€å¤§å­—ç¬¦æ•°ï¼Œé•¿æ¶ˆæ¯å°†è¢«åˆ‡åˆ† (Max response chunk size)',
            'reply_chunk_delay_sec': 'åˆ‡åˆ†æ¶ˆæ¯å‘é€ä¹‹é—´çš„é—´éš”(ç§’) (Chunk delay)',
            'max_concurrency': 'åŒæ—¶å¤„ç†æ¶ˆæ¯çš„æœ€å¤§å¹¶å‘çº¿ç¨‹æ•° (Max concurrency)',

            // æ™ºèƒ½åˆ†æ®µ
            'natural_split_enabled': 'å¯ç”¨æ‹ŸäººåŒ–æ™ºèƒ½åˆ†æ®µå‘é€ (Enable natural sentence splitting)',
            'natural_split_min_chars': 'æ™ºèƒ½åˆ†æ®µå…è®¸çš„æœ€å°æ®µè½é•¿åº¦ (Natural split min chars)',
            'natural_split_max_chars': 'æ™ºèƒ½åˆ†æ®µå…è®¸çš„æœ€å¤§æ®µè½é•¿åº¦ (Natural split max chars)',
            'natural_split_max_segments': 'å•æ¡å›å¤å…è®¸çš„æœ€å¤§åˆ†æ®µæ•° (Max split segments)',
            'natural_split_delay_sec': 'åˆ†æ®µå‘é€ä¹‹é—´çš„éšæœºé—´éš” [min, max] (Split delay range)',

            // æµå¼å›å¤
            'stream_reply': 'å¯ç”¨æ‰“å­—æœºæµå¼å›å¤æ•ˆæœ (Enable stream reply)',
            'stream_buffer_chars': 'æµå¼å›å¤çš„å­—ç¬¦ç¼“å†²é˜ˆå€¼ (Stream buffer size)',
            'stream_chunk_max_chars': 'æµå¼å›å¤å•æ¬¡å‘é€æœ€å¤§é•¿åº¦ (Stream chunk size)',

            // çƒ­æ›´æ–°ä¸é‡è¿
            'config_reload_sec': 'é…ç½®æ–‡ä»¶å˜æ›´æ£€æŸ¥é—´éš”(ç§’) (Config reload check interval)',
            'reload_ai_client_on_change': 'é…ç½®å˜æ›´æ—¶æ˜¯å¦é‡å»º AI å®¢æˆ·ç«¯å®ä¾‹ (Reload AI client on change)',
            'reload_ai_client_module': 'æ˜¯å¦é‡æ–°åŠ è½½ AI æ¨¡å—ä»£ç  (Reload AI module)',
            'keepalive_idle_sec': 'æ— æ¶ˆæ¯å¤šä¹…åè§¦å‘ä¸»åŠ¨ä¿æ´»é‡è¿(ç§’) (Idle keepalive timeout)',
            'reconnect_max_retries': 'è¿æ¥æ–­å¼€åçš„æœ€å¤§é‡è¯•æ¬¡æ•° (Max reconnect retries)',
            'reconnect_backoff_sec': 'é‡è¯•ç­‰å¾…çš„åŸºç¡€æ—¶é—´(ç§’) (Reconnect backoff)',
            'reconnect_max_delay_sec': 'é‡è¯•ç­‰å¾…çš„æœ€å¤§æ—¶é—´(ç§’) (Max reconnect delay)',

            // ç¾¤èŠæ§åˆ¶
            'group_reply_only_when_at': 'ç¾¤èŠä¸­æ˜¯å¦åªåœ¨è¢« @ æ—¶æ‰å›å¤ (Reply only when mentioned)',
            'group_include_sender': 'ç¾¤èŠå›å¤æ˜¯å¦å¼•ç”¨å‘é€è€…æ˜µç§° (Include sender name in group)',

            // æ¶ˆæ¯å‘é€
            'send_exact_match': 'æ˜¯å¦ä¸¥æ ¼åŒ¹é…çª—å£åç§° (Strict chat name matching)',
            'send_fallback_current_chat': 'å‘é€å¤±è´¥æ—¶æ˜¯å¦å°è¯•å‘ç»™å½“å‰æ‰“å¼€çš„çª—å£ (Fallback to current chat)',

            // è¿‡æ»¤è§„åˆ™
            'filter_mute': 'æ˜¯å¦å¿½ç•¥è®¾ä¸ºå…æ‰“æ‰°çš„ç¾¤/å¥½å‹ (Ignore muted chats)',
            'ignore_official': 'æ˜¯å¦å¿½ç•¥å…¬ä¼—å·æ¶ˆæ¯ (Ignore official accounts)',
            'ignore_service': 'æ˜¯å¦å¿½ç•¥æœåŠ¡å·æ¶ˆæ¯ (Ignore service accounts)',
            'ignore_names': 'å®Œå…¨å¿½ç•¥çš„æ˜µç§°åˆ—è¡¨ (Ignored names list)',
            'ignore_keywords': 'åŒ…å«ç‰¹å®šå…³é”®è¯çš„ä¼šè¯å°†è¢«å¿½ç•¥ (Ignored keywords list)',

            // ç™½åå•
            'whitelist_enabled': 'æ˜¯å¦å¯ç”¨ç™½åå•æ¨¡å¼ï¼Œå¯ç”¨åä»…å›å¤ç™½åå•å†…ä¼šè¯ (Enable whitelist mode)',
            'whitelist': 'å…è®¸è‡ªåŠ¨å›å¤çš„å¥½å‹æˆ–ç¾¤èŠåç§°åˆ—è¡¨ (Whitelist)',

            // ä¸ªæ€§åŒ–è®°å¿†
            'personalization_enabled': 'æ˜¯å¦å¯ç”¨ç”¨æˆ·ä¸ªæ€§åŒ–ç”»åƒè®°å¿† (Enable personalization)',
            'profile_update_frequency': 'æ¯éš”å¤šå°‘æ¡æ¶ˆæ¯æ›´æ–°ä¸€æ¬¡ç”¨æˆ·ç”»åƒ (Profile update frequency)',
            'remember_facts_enabled': 'æ˜¯å¦ä»å¯¹è¯ä¸­è‡ªåŠ¨æå–å¹¶è®°å¿†äº‹å® (Remember facts)',
            'max_context_facts': 'ä¸Šä¸‹æ–‡ä¸­æºå¸¦çš„æœ€å¤§äº‹å®æ•°é‡ (Max facts in context)',
            'profile_inject_in_prompt': 'æ˜¯å¦å°†ç”¨æˆ·ç”»åƒæ³¨å…¥åˆ° System Prompt (Inject profile in prompt)',

            // æ§åˆ¶å‘½ä»¤
            'control_commands_enabled': 'æ˜¯å¦å…è®¸ä½¿ç”¨ /pause ç­‰æ§åˆ¶æŒ‡ä»¤ (Enable control commands)',
            'control_command_prefix': 'æ§åˆ¶æŒ‡ä»¤çš„å‰ç¼€ç¬¦å· (Command prefix)',
            'control_allowed_users': 'æœ‰æƒä½¿ç”¨æŒ‡ä»¤çš„ç”¨æˆ·åˆ—è¡¨ï¼Œç©ºä¸ºæ‰€æœ‰äºº (Allowed command users)',
            'control_reply_visible': 'æŒ‡ä»¤æ‰§è¡Œç»“æœæ˜¯å¦å›å¤åˆ°èŠå¤©çª—å£ (Show command reply)',

            // å®šæ—¶é™é»˜
            'quiet_hours_enabled': 'æ˜¯å¦å¯ç”¨å¤œé—´é™é»˜æ¨¡å¼ (Enable quiet hours)',
            'quiet_hours_start': 'é™é»˜å¼€å§‹æ—¶é—´ HH:MM (Quiet start time)',
            'quiet_hours_end': 'é™é»˜ç»“æŸæ—¶é—´ HH:MM (Quiet end time)',
            'quiet_hours_reply': 'é™é»˜æœŸé—´çš„è‡ªåŠ¨å›å¤å†…å®¹ï¼Œç•™ç©ºä¸å› (Quiet auto-reply)',

            // ç”¨é‡ç›‘æ§
            'usage_tracking_enabled': 'æ˜¯å¦è®°å½• Token ä½¿ç”¨é‡ (Enable usage tracking)',
            'daily_token_limit': 'æ¯æ—¥ Token ä½¿ç”¨ç¡¬æ€§ä¸Šé™ï¼Œ0 ä¸ºä¸é™ (Daily token limit)',
            'token_warning_threshold': 'è¾¾åˆ°ä¸Šé™å¤šå°‘æ¯”ä¾‹æ—¶è§¦å‘æ—¥å¿—è­¦å‘Š (Token warning threshold)',

            // æƒ…æ„Ÿè¯†åˆ«
            'emotion_detection_enabled': 'æ˜¯å¦å¯ç”¨æƒ…ç»ªè¯†åˆ« (Enable emotion detection)',
            'emotion_detection_mode': 'è¯†åˆ«æ¨¡å¼ï¼šai(ç²¾å‡†ä½†è€—token) æˆ– keywords(å¿«é€Ÿ) (Emotion detection mode)',
            'emotion_inject_in_prompt': 'æ˜¯å¦å°†æƒ…ç»ªçŠ¶æ€æ³¨å…¥ System Prompt (Inject emotion in prompt)',
            'emotion_log_enabled': 'æ˜¯å¦è®°å½•æƒ…ç»ªåˆ†ææ—¥å¿— (Log emotion analysis)',
        };
        return descs[key] || '';
    }

    // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    // 3. ä¿å­˜é€»è¾‘
    // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

    async function saveConfig() {
        const btn = document.querySelector('.btn-primary');
        const originalText = btn.textContent;
        btn.textContent = 'â³ ä¿å­˜ä¸­...';
        btn.disabled = true;

        try {
            const newOverrides = { ...globalOverrides };

            // 1. API Changes (Same logic)
            if (!newOverrides.api) newOverrides.api = {};
            const apiInputs = {
                'base_url': document.getElementById('api-base-url').value,
                'api_key': document.getElementById('api-key').value,
                'model': document.getElementById('api-model').value,
                'max_tokens': parseInt(document.getElementById('api-max-tokens').value) || 512,
                'temperature': parseFloat(document.getElementById('api-temperature').value) || 0.7
            };

            for (const [k, v] of Object.entries(apiInputs)) {
                if (k === 'api_key' && !v) continue; // Skip empty key
                if (v !== globalDefaults.api[k]) {
                    newOverrides.api[k] = v;
                } else if (newOverrides.api[k]) {
                    delete newOverrides.api[k];
                }
            }

            // 2. Bot Changes (Scan all inputs in all tabs)
            if (!newOverrides.bot) newOverrides.bot = {};
            const botInputs = document.querySelectorAll('[data-key]');

            botInputs.forEach(input => {
                const key = input.dataset.key;
                const type = input.dataset.type;
                let val;

                if (type === 'boolean') {
                    // For switch, the input is inside wrapper or is the wrapper input
                    val = input.type === 'checkbox' ? input.checked : (input.querySelector('input') ? input.querySelector('input').checked : false);
                    // Correcting for our custom switch wrapper if needed, but selector finds inputs usually
                    if (input.classList.contains('toggle-input')) val = input.checked;
                } else if (type === 'int') {
                    val = parseInt(input.value);
                } else if (type === 'float') {
                    val = parseFloat(input.value);
                } else if (type === 'json') {
                    try {
                        val = JSON.parse(input.value);
                    } catch (e) {
                        // invalid json, ignore or alert?
                        return;
                    }
                } else if (type === 'array') {
                    try {
                        val = JSON.parse(input.value);
                    } catch (e) {
                        val = input.value.split(',').map(s => s.trim()).filter(s => s);
                    }
                } else {
                    val = input.value;
                }

                if (val !== globalDefaults.bot?.[key]) {
                    newOverrides.bot[key] = val;
                } else if (newOverrides.bot[key]) {
                    delete newOverrides.bot[key];
                }
            });

            // Send
            const resp = await fetch('/api/config', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(newOverrides)
            });
            const res = await resp.json();

            if (res.success) {
                showToast('é…ç½®å·²ä¿å­˜ï¼Œè¯·é‡å¯æœºå™¨äººç”Ÿæ•ˆ', 'success');
                // Refresh data
                const refreshResp = await fetch('/api/config');
                const data = await refreshResp.json();
                globalOverrides = data.overrides;
            } else {
                showToast('ä¿å­˜å¤±è´¥: ' + (res.message || res.error), 'error');
            }

        } catch (e) {
            console.error(e);
            showToast('è¯·æ±‚å¤±è´¥: ' + e.message, 'error');
        } finally {
            btn.textContent = originalText;
            btn.disabled = false;
        }
    }

    function showStatus(msg, type) {
        const el = document.getElementById('status-msg');
        el.innerHTML = msg;
        el.style.color = type === 'error' ? '#ff6b6b' : (type === 'success' ? '#51cf66' : 'var(--text-secondary)');

        // Auto reset
        if (type !== 'normal') {
            setTimeout(() => {
                el.innerHTML = '<span>âœ…</span> å‡†å¤‡å°±ç»ª';
                el.style.color = 'var(--text-secondary)';
            }, 5000);
        }
    }
</script>
{% endblock %}