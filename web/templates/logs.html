{% extends "base.html" %}

{% block title %}è¿è¡Œæ—¥å¿— - å¾®ä¿¡æœºå™¨äºº{% endblock %}

{% block extra_css %}
<style>
    .logs-container {
        background: #000;
        border-radius: 24px;
        padding: 24px;
        font-family: 'JetBrains Mono', 'Fira Code', 'Consolas', monospace;
        font-size: 0.9rem;
        height: calc(100vh - 160px);
        overflow-y: auto;
        border: 1px solid var(--card-border);
        color: #d4d4d4;
        white-space: pre-wrap;
        box-shadow: 0 20px 50px rgba(0, 0, 0, 0.5);
        backdrop-filter: blur(10px);
        box-shadow: inset 0 0 100px rgba(0, 0, 0, 0.8);
    }

    /* Terminal Scrollbar */
    .logs-container::-webkit-scrollbar {
        width: 12px;
        background: #0f172a;
        border-top-right-radius: 24px;
        border-bottom-right-radius: 24px;
    }

    .logs-container::-webkit-scrollbar-thumb {
        background: #334155;
        border: 2px solid #0f172a;
        border-radius: 6px;
    }

    .log-line {
        padding: 4px 12px;
        line-height: 1.5;
        border-left: 2px solid transparent;
        transition: background 0.2s;
        border-radius: 4px;
    }

    .log-line:hover {
        background: rgba(255, 255, 255, 0.05);
    }

    .log-line:last-child {
        border-bottom: none;
    }

    .log-time {
        color: #569cd6;
        margin-right: 12px;
        opacity: 0.7;
    }

    .log-level-INFO {
        color: #4ec9b0;
        border-left-color: #4ec9b0;
    }

    .log-level-WARNING {
        color: #f59e0b;
        border-left-color: #f59e0b;
        background: rgba(245, 158, 11, 0.05);
    }

    .log-level-ERROR {
        color: #ef4444;
        font-weight: bold;
        border-left-color: #ef4444;
        background: rgba(239, 68, 68, 0.1);
    }

    .log-level-DEBUG {
        color: #64748b;
        border-left-color: #64748b;
    }

    .last-updated {
        font-size: 0.85rem;
        color: var(--text-secondary);
        margin-left: 15px;
        background: rgba(255, 255, 255, 0.05);
        padding: 4px 12px;
        border-radius: 12px;
    }

    .toolbar {
        display: flex;
        align-items: center;
        gap: 12px;
        height: 100%;
    }

    .auto-scroll-label {
        display: flex;
        align-items: center;
        cursor: pointer;
        padding: 8px 16px;
        background: rgba(255, 255, 255, 0.05);
        border-radius: 12px;
        font-size: 0.9rem;
        transition: all 0.2s;
        user-select: none;
        border: 1px solid transparent;
    }

    .auto-scroll-label:hover {
        background: rgba(255, 255, 255, 0.1);
    }

    .auto-scroll-label input:checked+span {
        color: var(--accent-primary);
    }

    .auto-scroll-label input {
        margin-right: 8px;
        accent-color: var(--accent-primary);
    }

    .btn-log-action {
        padding: 8px 16px;
        font-size: 0.9rem;
    }
</style>
{% endblock %}

{% block content %}
<div class="page-header">
    <div>
        <h1 class="page-title">è¿è¡Œæ—¥å¿—</h1>
        <div style="display: flex; align-items: center; margin-top: 8px;">
            <span class="status-dot"
                style="display: inline-block; width: 8px; height: 8px; background: #22c55e; border-radius: 50%; margin-right: 8px; box-shadow: 0 0 10px #22c55e;"></span>
            <div class="page-subtitle" style="margin: 0;">å®æ—¶ç›‘æ§ç³»ç»Ÿè¾“å‡º</div>
            <span id="last-updated" class="last-updated">ç­‰å¾…åŒæ­¥...</span>
        </div>
    </div>

    <div class="toolbar">
        <label class="auto-scroll-label">
            <input type="checkbox" id="auto-scroll" checked>
            <span>è‡ªåŠ¨æ»šåŠ¨</span>
        </label>
        <button class="btn btn-refresh btn-log-action" onclick="fetchLogs()">
            ğŸ”„ åˆ·æ–°
        </button>
        <button class="btn btn-log-action" onclick="clearLogs()"
            style="background: rgba(239, 68, 68, 0.1); color: #f87171; border: 1px solid rgba(239, 68, 68, 0.2);">
            ğŸ—‘ï¸ æ¸…ç©º
        </button>
    </div>
</div>

<div class="logs-container" id="logs-view">
    <div
        style="display: flex; flex-direction: column; align-items: center; justify-content: center; height: 100%; color: #334155; user-select: none;">
        <div style="font-size: 3rem; margin-bottom: 20px;">_</div>
        <div class="page-subtitle">ç­‰å¾…æ—¥å¿—æµæ¥å…¥...</div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    const logsView = document.getElementById('logs-view');
    const autoScrollCheck = document.getElementById('auto-scroll');
    const lastUpdated = document.getElementById('last-updated');
    let isFetching = false;
    let lineNumber = 0;

    function formatLine(line, index) {
        // Simple highlighting
        let className = 'log-line';
        if (line.includes('ERROR') || line.includes('Exception')) className += ' log-level-ERROR';
        else if (line.includes('WARNING')) className += ' log-level-WARNING';
        else if (line.includes('DEBUG')) className += ' log-level-DEBUG';
        else className += ' log-level-INFO';

        const num = String(index + 1).padStart(4, ' ');
        return `<div class="${className}"><span class="log-line-num" style="color:#475569;margin-right:12px;user-select:none;">${num}</span>${escapeHtml(line)}</div>`;
    }

    function escapeHtml(text) {
        const div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML;
    }

    async function fetchLogs() {
        if (isFetching) return;
        isFetching = true;

        try {
            const resp = await fetch('/api/logs?lines=200');
            const data = await resp.json();

            if (data.success) {
                logsView.innerHTML = data.logs.map((line, i) => formatLine(line, i)).join('');
                lastUpdated.textContent = 'æ›´æ–°äº ' + new Date().toLocaleTimeString();

                if (autoScrollCheck.checked) {
                    logsView.scrollTop = logsView.scrollHeight;
                }
            } else {
                logsView.innerHTML = `<div style="color: #f44747; padding: 10px;">è¯»å–æ—¥å¿—å¤±è´¥: ${data.error}</div>`;
            }
        } catch (e) {
            console.error('Fetch logs error:', e);
            logsView.innerHTML = `<div style="color: #f44747; padding: 10px;">ç½‘ç»œè¯·æ±‚å¤±è´¥</div>`;
        } finally {
            isFetching = false;
        }
    }

    async function clearLogs() {
        if (!confirm('ç¡®å®šè¦æ¸…ç©ºæ—¥å¿—å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ¢å¤ã€‚')) return;
        try {
            const resp = await fetch('/api/logs', { method: 'DELETE' });
            const data = await resp.json();
            if (data.success) {
                logsView.innerHTML = '';
                showToast('æ—¥å¿—å·²æ¸…ç©º', 'success');
                fetchLogs(); // é‡æ–°åŠ è½½ä»¥æ˜¾ç¤ºç©ºçŠ¶æ€æˆ–æ–°æ—¥å¿—
            } else {
                showToast('æ¸…ç©ºå¤±è´¥: ' + data.error, 'error');
            }
        } catch (e) {
            showToast('ç½‘ç»œè¯·æ±‚å¤±è´¥', 'error');
        }
    }

    // Initial load
    fetchLogs();

    // Auto refresh every 3 seconds
    setInterval(fetchLogs, 3000);
</script>
{% endblock %}