{% extends "base.html" %}

{% block title %}èŠå¤©æ§åˆ¶å° - WeChat Ultra{% endblock %}

{% block extra_css %}
<style>
    .chat-container {
        display: flex;
        flex-direction: column;
        height: calc(100vh - 160px);
        gap: 24px;
        position: relative;
    }

    .message-list {
        flex: 1;
        overflow-y: auto;
        padding-right: 12px;
        display: flex;
        flex-direction: column;
        gap: 20px;
        scroll-behavior: smooth;
    }

    .message {
        display: flex;
        flex-direction: column;
        max-width: 80%;
        animation: slideIn 0.4s cubic-bezier(0.2, 0.8, 0.2, 1);
        position: relative;
    }

    @keyframes slideIn {
        from {
            opacity: 0;
            transform: translateY(20px);
        }

        to {
            opacity: 1;
            transform: translateY(0);
        }
    }

    .message.incoming {
        align-self: flex-start;
    }

    .message.outgoing {
        align-self: flex-end;
    }

    .message-bubble {
        padding: 16px 20px;
        border-radius: 20px;
        position: relative;
        font-size: 0.95rem;
        line-height: 1.6;
        box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
        backdrop-filter: blur(10px);
    }

    .message.incoming .message-bubble {
        background: rgba(30, 41, 59, 0.6);
        color: var(--text-primary);
        border-bottom-left-radius: 4px;
        border: 1px solid rgba(255, 255, 255, 0.05);
    }

    .message.outgoing .message-bubble {
        background: var(--accent-gradient);
        color: white;
        border-bottom-right-radius: 4px;
        box-shadow: 0 8px 25px rgba(56, 189, 248, 0.25);
        border: 1px solid rgba(255, 255, 255, 0.1);
    }

    .message-meta {
        font-size: 0.75rem;
        margin-bottom: 6px;
        opacity: 0.7;
        display: flex;
        gap: 8px;
        color: var(--text-secondary);
        font-weight: 500;
        padding: 0 4px;
    }

    .message.outgoing .message-meta {
        justify-content: flex-end;
        color: rgba(255, 255, 255, 0.8);
    }

    .input-area {
        background: var(--card-bg);
        border: 1px solid var(--card-border);
        border-radius: 20px;
        padding: 20px;
        display: flex;
        gap: 16px;
        align-items: flex-end;
        backdrop-filter: blur(var(--glass-blur));
        box-shadow: 0 -10px 40px rgba(0, 0, 0, 0.2);
    }

    .target-select {
        background: rgba(15, 23, 42, 0.6);
        border: 1px solid var(--card-border);
        color: var(--text-primary);
        padding: 12px 16px;
        border-radius: 12px;
        outline: none;
        width: 180px;
        font-size: 0.9rem;
        transition: all 0.3s ease;
    }

    .target-select:focus {
        border-color: var(--accent-primary);
        box-shadow: 0 0 0 2px rgba(56, 189, 248, 0.2);
    }

    .message-input {
        flex: 1;
        background: rgba(15, 23, 42, 0.6);
        border: 1px solid var(--card-border);
        color: var(--text-primary);
        padding: 12px 16px;
        border-radius: 12px;
        resize: none;
        height: 48px;
        min-height: 48px;
        max-height: 150px;
        outline: none;
        transition: all 0.3s ease;
        font-family: inherit;
        font-size: 0.95rem;
    }

    .message-input:focus {
        border-color: var(--accent-primary);
        box-shadow: 0 0 0 2px rgba(56, 189, 248, 0.2);
    }

    .btn-send {
        background: var(--accent-gradient);
        color: white;
        height: 48px;
        border-radius: 12px;
        padding: 0 24px;
        font-weight: 600;
        box-shadow: 0 4px 15px rgba(56, 189, 248, 0.3);
        border: none;
    }

    .btn-send:hover {
        transform: translateY(-2px);
        box-shadow: 0 6px 20px rgba(56, 189, 248, 0.4);
    }
</style>
{% endblock %}

{% block content %}
<div class="page-header">
    <div>
        <h1 class="page-title">å®æ—¶å¯¹è¯</h1>
        <div class="page-subtitle">ç›‘æ§å¹¶å¹²é¢„æœºå™¨äººå¯¹è¯æµ</div>
    </div>
</div>

<div class="chat-container">
    <div id="message-list" class="message-list">
        <!-- æ¶ˆæ¯æµ -->
        <div
            style="display: flex; flex-direction: column; align-items: center; justify-content: center; height: 100%; color: var(--text-muted); gap: 10px;">
            <div style="font-size: 3rem; opacity: 0.2;">ğŸ’¬</div>
            <div>æ­£åœ¨å»ºç«‹åŠ å¯†è¿æ¥...</div>
        </div>
    </div>

    <div class="input-area">
        <input type="text" id="target-input" class="target-select" placeholder="å‘é€ç»™ (å¦‚ friend:å¼ ä¸‰)" value="">
        <textarea id="message-input" class="message-input" placeholder="è¾“å…¥æŒ‡ä»¤æˆ–å›å¤... (Enter å‘é€)"></textarea>
        <button class="btn btn-send" onclick="sendMessage()">
            å‘é€ ğŸš€
        </button>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    const msgList = document.getElementById('message-list');
    const targetInput = document.getElementById('target-input');
    const msgInput = document.getElementById('message-input');

    let lastMsgId = null;
    let isPolling = false;

    // è‡ªåŠ¨è°ƒæ•´è¾“å…¥æ¡†é«˜åº¦
    msgInput.addEventListener('input', function () {
        this.style.height = 'auto';
        this.style.height = (this.scrollHeight) + 'px';
        if (this.value === '') this.style.height = '42px';
    });

    // å¿«æ·é”®å‘é€
    msgInput.addEventListener('keydown', function (e) {
        if (e.key === 'Enter' && !e.shiftKey) {
            e.preventDefault();
            sendMessage();
        }
    });

    function formatTime(ts) {
        return new Date(ts * 1000).toLocaleTimeString();
    }

    function renderMessage(msg) {
        const isOutgoing = msg.type === 'outgoing';
        const className = isOutgoing ? 'outgoing' : 'incoming';
        const sender = isOutgoing ? 'Bot' : msg.sender;
        const target = isOutgoing ? msg.recipient : '';

        // è‡ªåŠ¨å¡«å……å›å¤ç›®æ ‡
        if (!isOutgoing && msg.sender) {
            // å¦‚æœæ˜¯ç¾¤æ¶ˆæ¯
            const chatName = msg.recipient.startsWith('group:') ? msg.recipient : `friend:${msg.sender}`;
            // ç®€å•çš„é€»è¾‘: ç‚¹å‡»æ¶ˆæ¯å¯è®¾ä¸ºç›®æ ‡ (è¿™é‡Œæš‚ä¸å®ç°ç‚¹å‡»ï¼Œåªä¿ç•™é€»è¾‘)
        }

        return `
            <div class="message ${className}" data-id="${msg.id}">
                <div class="message-meta">
                    <span>${sender} ${target ? 'â†’ ' + target : ''}</span>
                    <span>${formatTime(msg.timestamp)}</span>
                </div>
                <div class="message-bubble">
                    ${msg.content.replace(/\n/g, '<br>')}
                </div>
            </div>
        `;
    }

    async function pollMessages() {
        if (isPolling) return;
        isPolling = true;

        try {
            const resp = await fetch('/api/messages');
            const data = await resp.json();

            if (data.success && data.messages.length > 0) {
                // ç®€å•çš„å…¨é‡æ¸²æŸ“ (ç”Ÿäº§ç¯å¢ƒåº”åšå¢é‡)
                const html = data.messages.map(renderMessage).join('');

                // æ£€æŸ¥æ˜¯å¦åœ¨åº•éƒ¨
                const isAtBottom = msgList.scrollHeight - msgList.scrollTop <= msgList.clientHeight + 100;

                msgList.innerHTML = html;

                if (isAtBottom || !lastMsgId) {
                    msgList.scrollTop = msgList.scrollHeight;
                }

                lastMsgId = data.messages[data.messages.length - 1].id;

                // å¦‚æœæœ‰æœ€æ–°æ”¶åˆ°çš„æ¶ˆæ¯ï¼Œè‡ªåŠ¨è®¾ç½®ç›®æ ‡
                const lastIncoming = [...data.messages].reverse().find(m => m.type === 'incoming');
                if (lastIncoming && !targetInput.value) {
                    const cleanRecipient = lastIncoming.recipient.replace('group:', 'group:').replace('friend:', 'friend:'); // ä¿æŒåŸæ ·å³å¯
                    // ä¼˜å…ˆå›å¤æœ€åè¯´è¯çš„äººï¼ˆå¦‚æœæ˜¯ç¾¤èŠåˆ™å›å¤ç¾¤ï¼‰
                    if (lastIncoming.recipient.includes('group:')) {
                        targetInput.placeholder = `å›å¤ ${lastIncoming.recipient}`;
                    } else {
                        targetInput.placeholder = `å›å¤ friend:${lastIncoming.sender}`;
                    }
                }
            } else if (data.messages.length === 0) {
                msgList.innerHTML = '<div style="text-align: center; color: var(--text-secondary); margin-top: 50px;">æš‚æ— æ¶ˆæ¯è®°å½•</div>';
            }
        } catch (e) {
            console.error('Poll error:', e);
        } finally {
            isPolling = false;
        }
    }

    async function sendMessage() {
        const content = msgInput.value.trim();
        let target = targetInput.value.trim();

        // å°è¯•ä» placeholder è·å–
        if (!target && targetInput.placeholder.startsWith('å›å¤ ')) {
            target = targetInput.placeholder.replace('å›å¤ ', '');
        }

        if (!target) {
            showToast('è¯·æŒ‡å®šå‘é€ç›®æ ‡ (ä¾‹å¦‚ friend:å¼ ä¸‰)', 'warning');
            return;
        }
        if (!content) return;

        try {
            const resp = await fetch('/api/send', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ target, content })
            });
            const data = await resp.json();

            if (data.success) {
                msgInput.value = '';
                msgInput.style.height = '42px';
                showToast('æ¶ˆæ¯å·²å‘é€', 'success');
                pollMessages(); // ç«‹å³åˆ·æ–°
            } else {
                showToast('å‘é€å¤±è´¥: ' + data.error, 'error');
            }
        } catch (e) {
            showToast('ç½‘ç»œé”™è¯¯', 'error');
        }
    }

    // å¯åŠ¨è½®è¯¢
    pollMessages();
    setInterval(pollMessages, 2000);
</script>
{% endblock %}