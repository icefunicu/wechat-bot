<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="Content-Security-Policy"
        content="default-src 'self'; script-src 'self' 'unsafe-inline'; style-src 'self' 'unsafe-inline' https://fonts.googleapis.com; font-src 'self' https://fonts.gstatic.com; connect-src 'self' http://localhost:*;">
    <title>微信AI助手</title>
    <link rel="stylesheet" href="css/app.css">
</head>

<body class="no-select">
    <!-- SVG 图标定义 -->
    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
        <symbol id="icon-bot" viewBox="0 0 24 24">
            <path d="M12 8V4H8" />
            <rect x="4" y="8" width="16" height="12" rx="2" />
            <circle cx="9" cy="13" r="1" />
            <circle cx="15" cy="13" r="1" />
            <path d="M9 17h6" />
        </symbol>
        <symbol id="icon-dashboard" viewBox="0 0 24 24">
            <rect x="3" y="3" width="7" height="9" rx="1" />
            <rect x="14" y="3" width="7" height="5" rx="1" />
            <rect x="14" y="12" width="7" height="9" rx="1" />
            <rect x="3" y="16" width="7" height="5" rx="1" />
        </symbol>
        <symbol id="icon-message" viewBox="0 0 24 24">
            <path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z" />
        </symbol>
        <symbol id="icon-settings" viewBox="0 0 24 24">
            <circle cx="12" cy="12" r="3" />
            <path
                d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z" />
        </symbol>
        <symbol id="icon-terminal" viewBox="0 0 24 24">
            <polyline points="4 17 10 11 4 5" />
            <line x1="12" y1="19" x2="20" y2="19" />
        </symbol>
        <symbol id="icon-clock" viewBox="0 0 24 24">
            <circle cx="12" cy="12" r="10" />
            <polyline points="12 6 12 12 16 14" />
        </symbol>
        <symbol id="icon-zap" viewBox="0 0 24 24">
            <polygon points="13 2 3 14 12 14 11 22 21 10 12 10 13 2" />
        </symbol>
        <symbol id="icon-bar-chart" viewBox="0 0 24 24">
            <line x1="12" y1="20" x2="12" y2="10" />
            <line x1="18" y1="20" x2="18" y2="4" />
            <line x1="6" y1="20" x2="6" y2="16" />
        </symbol>
        <symbol id="icon-activity" viewBox="0 0 24 24">
            <polyline points="22 12 18 12 15 21 9 3 6 12 2 12" />
        </symbol>
        <symbol id="icon-play" viewBox="0 0 24 24">
            <polygon points="5 3 19 12 5 21 5 3" />
        </symbol>
        <symbol id="icon-square" viewBox="0 0 24 24">
            <rect x="4" y="4" width="16" height="16" rx="2" />
        </symbol>
        <symbol id="icon-pause" viewBox="0 0 24 24">
            <rect x="6" y="4" width="4" height="16" />
            <rect x="14" y="4" width="4" height="16" />
        </symbol>
        <symbol id="icon-refresh" viewBox="0 0 24 24">
            <polyline points="23 4 23 10 17 10" />
            <path d="M20.49 15a9 9 0 1 1-2.12-9.36L23 10" />
        </symbol>
        <symbol id="icon-external" viewBox="0 0 24 24">
            <path d="M18 13v6a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h6" />
            <polyline points="15 3 21 3 21 9" />
            <line x1="10" y1="14" x2="21" y2="3" />
        </symbol>
        <symbol id="icon-minimize-2" viewBox="0 0 24 24">
            <polyline points="4 14 10 14 10 20" />
            <polyline points="20 10 14 10 14 4" />
            <line x1="14" y1="10" x2="21" y2="3" />
            <line x1="3" y1="21" x2="10" y2="14" />
        </symbol>
        <symbol id="icon-file-text" viewBox="0 0 24 24">
            <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z" />
            <polyline points="14 2 14 8 20 8" />
            <line x1="16" y1="13" x2="8" y2="13" />
            <line x1="16" y1="17" x2="8" y2="17" />
            <polyline points="10 9 9 9 8 9" />
        </symbol>
        <symbol id="icon-user" viewBox="0 0 24 24">
            <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2" />
            <circle cx="12" cy="7" r="4" />
        </symbol>
        <symbol id="icon-inbox" viewBox="0 0 24 24">
            <polyline points="22 12 16 12 14 15 10 15 8 12 2 12" />
            <path
                d="M5.45 5.11L2 12v6a2 2 0 0 0 2 2h16a2 2 0 0 0 2-2v-6l-3.45-6.89A2 2 0 0 0 16.76 4H7.24a2 2 0 0 0-1.79 1.11z" />
        </symbol>
        <symbol id="icon-search" viewBox="0 0 24 24">
            <circle cx="11" cy="11" r="8" />
            <line x1="21" y1="21" x2="16.65" y2="16.65" />
        </symbol>
        <symbol id="icon-trash" viewBox="0 0 24 24">
            <polyline points="3 6 5 6 21 6" />
            <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2" />
        </symbol>
        <symbol id="icon-save" viewBox="0 0 24 24">
            <path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z" />
            <polyline points="17 21 17 13 7 13 7 21" />
            <polyline points="7 3 7 8 15 8" />
        </symbol>
        <symbol id="icon-check" viewBox="0 0 24 24">
            <polyline points="20 6 9 17 4 12" />
        </symbol>
        <symbol id="icon-x" viewBox="0 0 24 24">
            <line x1="18" y1="6" x2="6" y2="18" />
            <line x1="6" y1="6" x2="18" y2="18" />
        </symbol>
        <symbol id="icon-alert-circle" viewBox="0 0 24 24">
            <circle cx="12" cy="12" r="10" />
            <line x1="12" y1="8" x2="12" y2="12" />
            <line x1="12" y1="16" x2="12.01" y2="16" />
        </symbol>
        <symbol id="icon-info" viewBox="0 0 24 24">
            <circle cx="12" cy="12" r="10" />
            <line x1="12" y1="16" x2="12" y2="12" />
            <line x1="12" y1="8" x2="12.01" y2="8" />
        </symbol>
        <symbol id="icon-minus" viewBox="0 0 24 24">
            <line x1="5" y1="12" x2="19" y2="12" />
        </symbol>
        <symbol id="icon-maximize" viewBox="0 0 24 24">
            <rect x="3" y="3" width="18" height="18" rx="2" />
        </symbol>
        <symbol id="icon-plus" viewBox="0 0 24 24">
            <line x1="12" y1="5" x2="12" y2="19"></line>
            <line x1="5" y1="12" x2="19" y2="12"></line>
        </symbol>
    </svg>

    <!-- 自定义标题栏 -->
    <header class="titlebar">
        <div class="titlebar-left">
            <svg class="icon titlebar-logo">
                <use href="#icon-bot" />
            </svg>
            <span class="titlebar-title">微信AI助手</span>
        </div>
        <div class="titlebar-controls">
            <button class="titlebar-btn" id="btn-minimize" title="最小化">
                <svg class="icon">
                    <use href="#icon-minus" />
                </svg>
            </button>
            <button class="titlebar-btn" id="btn-maximize" title="最大化">
                <svg class="icon">
                    <use href="#icon-maximize" />
                </svg>
            </button>
            <button class="titlebar-btn btn-close" id="btn-close" title="关闭">
                <svg class="icon">
                    <use href="#icon-x" />
                </svg>
            </button>
        </div>
    </header>

    <!-- 主容器 -->
    <div class="app-container">
        <!-- 侧边栏 -->
        <nav class="sidebar">
            <div class="sidebar-nav">
                <a href="#" class="nav-item active" data-page="dashboard">
                    <svg class="icon">
                        <use href="#icon-dashboard" />
                    </svg>
                    <span class="nav-label">仪表盘</span>
                </a>
                <a href="#" class="nav-item" data-page="messages">
                    <svg class="icon">
                        <use href="#icon-message" />
                    </svg>
                    <span class="nav-label">消息</span>
                </a>
                <a href="#" class="nav-item" data-page="settings">
                    <svg class="icon">
                        <use href="#icon-settings" />
                    </svg>
                    <span class="nav-label">设置</span>
                </a>
                <a href="#" class="nav-item" data-page="logs">
                    <svg class="icon">
                        <use href="#icon-terminal" />
                    </svg>
                    <span class="nav-label">日志</span>
                </a>
            </div>

            <div class="sidebar-footer">
                <div class="status-badge" id="status-badge">
                    <span class="status-dot offline"></span>
                    <span class="status-label">未连接</span>
                </div>
                <div class="version-text" id="version-text">v1.0.0</div>
            </div>
        </nav>

        <!-- 主内容区 -->
        <main class="main-content">
            <!-- 仪表盘 -->
            <section class="page active" id="page-dashboard">
                <div class="page-header">
                    <h1 class="page-title">仪表盘</h1>
                    <div class="page-actions">
                        <button class="btn btn-primary" id="btn-toggle-bot">
                            <svg class="icon icon-sm">
                                <use href="#icon-play" />
                            </svg>
                            <span>启动机器人</span>
                        </button>
                    </div>
                </div>

                <!-- 统计卡片 -->
                <div class="stats-row">
                    <div class="stat-card">
                        <div class="stat-icon">
                            <svg class="icon">
                                <use href="#icon-clock" />
                            </svg>
                        </div>
                        <div class="stat-content">
                            <div class="stat-value" id="stat-uptime">--</div>
                            <div class="stat-label">运行时长</div>
                        </div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon">
                            <svg class="icon">
                                <use href="#icon-message" />
                            </svg>
                        </div>
                        <div class="stat-content">
                            <div class="stat-value" id="stat-today-replies">0</div>
                            <div class="stat-label">今日回复</div>
                        </div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon">
                            <svg class="icon">
                                <use href="#icon-zap" />
                            </svg>
                        </div>
                        <div class="stat-content">
                            <div class="stat-value" id="stat-today-tokens">0</div>
                            <div class="stat-label">今日Token</div>
                        </div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon">
                            <svg class="icon">
                                <use href="#icon-bar-chart" />
                            </svg>
                        </div>
                        <div class="stat-content">
                            <div class="stat-value" id="stat-total-replies">0</div>
                            <div class="stat-label">累计回复</div>
                        </div>
                    </div>
                </div>

                <!-- 卡片网格 -->
                <div class="card-grid">
                    <!-- 机器人状态 -->
                    <div class="card">
                        <div class="card-header">
                            <h2 class="card-title">机器人状态</h2>
                        </div>
                        <div class="card-body">
                            <div class="bot-control">
                                <div class="bot-avatar">
                                    <svg class="icon icon-xl">
                                        <use href="#icon-bot" />
                                    </svg>
                                </div>
                                <div class="bot-info">
                                    <div class="bot-name">微信AI助手</div>
                                    <div class="bot-state" id="bot-state">
                                        <span class="bot-state-dot offline"></span>
                                        <span class="bot-state-text">离线</span>
                                    </div>
                                </div>
                            </div>
                            <div class="bot-actions">
                                <button class="btn btn-secondary btn-sm" id="btn-pause">
                                    <svg class="icon icon-sm">
                                        <use href="#icon-pause" />
                                    </svg>
                                    <span>暂停</span>
                                </button>
                                <button class="btn btn-secondary btn-sm" id="btn-restart">
                                    <svg class="icon icon-sm">
                                        <use href="#icon-refresh" />
                                    </svg>
                                    <span>重启</span>
                                </button>
                            </div>
                        </div>
                    </div>

                    <!-- 快捷操作 -->
                    <div class="card">
                        <div class="card-header">
                            <h2 class="card-title">快捷操作</h2>
                        </div>
                        <div class="card-body">
                            <div class="quick-grid">
                                <button class="quick-btn" id="btn-open-wechat">
                                    <svg class="icon">
                                        <use href="#icon-external" />
                                    </svg>
                                    <span>打开微信</span>
                                </button>
                                <button class="quick-btn" id="btn-view-logs">
                                    <svg class="icon">
                                        <use href="#icon-file-text" />
                                    </svg>
                                    <span>查看日志</span>
                                </button>
                                <button class="quick-btn" id="btn-refresh-status">
                                    <svg class="icon">
                                        <use href="#icon-refresh" />
                                    </svg>
                                    <span>刷新状态</span>
                                </button>
                                <button class="quick-btn" id="btn-minimize-tray">
                                    <svg class="icon">
                                        <use href="#icon-minimize-2" />
                                    </svg>
                                    <span>最小化</span>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- 最近消息 -->
                <div class="card full-width">
                    <div class="card-header">
                        <h2 class="card-title">最近消息</h2>
                        <button class="btn btn-ghost btn-sm" id="btn-view-all-messages">查看全部</button>
                    </div>
                    <div class="card-body">
                        <div class="message-list" id="recent-messages">
                            <div class="empty-state">
                                <svg class="icon">
                                    <use href="#icon-inbox" />
                                </svg>
                                <span class="empty-state-text">暂无消息记录</span>
                            </div>
                        </div>
                    </div>
                </div>




            </section>
            <!-- 消息页面 -->
            <section class="page" id="page-messages">
                <div class="page-header">
                    <h1 class="page-title">消息中心</h1>
                    <div class="page-actions">
                        <div class="search-wrapper">
                            <svg class="icon">
                                <use href="#icon-search" />
                            </svg>
                            <input type="text" class="search-input" placeholder="搜索消息..." id="message-search">
                        </div>
                        <button class="btn btn-secondary btn-sm" id="btn-refresh-messages">
                            <svg class="icon icon-sm">
                                <use href="#icon-refresh" />
                            </svg>
                            <span>刷新</span>
                        </button>
                    </div>
                </div>

                <div class="message-list full-height" id="all-messages">
                    <div class="loading-state">
                        <div class="spinner"></div>
                        <span>加载中...</span>
                    </div>
                </div>
            </section>

            <!-- 设置页面 -->
            <section class="page" id="page-settings">
                <div class="page-header">
                    <h1 class="page-title">配置中心</h1>
                    <div class="page-actions">
                        <button class="btn btn-secondary btn-sm" id="btn-refresh-config">
                            <svg class="icon icon-sm">
                                <use href="#icon-refresh" />
                            </svg>
                            <span>刷新</span>
                        </button>
                        <button class="btn btn-primary" id="btn-save-settings">
                            <svg class="icon icon-sm">
                                <use href="#icon-save" />
                            </svg>
                            <span>保存配置</span>
                        </button>
                    </div>
                </div>

                <div class="settings-container">
                    <!-- 当前配置 Hero (由 JS 动态渲染) -->
                    <div id="current-config-hero">
                        <div class="config-hero-card" style="opacity: 0.5; pointer-events: none;">
                            <div class="hero-content">
                                <div class="hero-title">
                                    <span class="hero-name">加载配置中...</span>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- API 预设 -->
                    <div class="settings-card">
                        <div class="settings-card-header" style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                            <h2 class="settings-card-title" style="margin-bottom: 0;">API 预设</h2>
                            <button class="btn btn-secondary btn-sm" id="btn-add-preset">
                                <svg class="icon icon-sm">
                                    <use href="#icon-plus" />
                                </svg>
                                <span>新增</span>
                            </button>
                        </div>
                        <div class="preset-list" id="preset-list">
                            <div class="loading-state">
                                <div class="spinner"></div>
                                <span>加载预设中...</span>
                            </div>
                        </div>
                    </div>

                    <!-- 机器人设置 -->
                    <div class="settings-card">
                        <h2 class="settings-card-title">机器人设置</h2>
                        <div class="settings-grid">
                            <div class="form-group">
                                <label class="form-label">微信昵称</label>
                                <input type="text" id="setting-self-name" placeholder="你的微信昵称">
                            </div>
                            <div class="form-group">
                                <label class="form-label">回复后缀</label>
                                <input type="text" id="setting-reply-suffix" placeholder="（AI回复）">
                            </div>
                            <div class="form-group">
                                <label class="form-checkbox" style="display: flex; align-items: center; gap: 12px; cursor: pointer;">
                                    <input type="checkbox" id="setting-stream-reply">
                                    <span class="form-checkbox-label">启用流式回复</span>
                                </label>
                            </div>
                            <div class="form-group">
                                <label class="form-checkbox" style="display: flex; align-items: center; gap: 12px; cursor: pointer;">
                                    <input type="checkbox" id="setting-group-at-only">
                                    <span class="form-checkbox-label">群聊仅@时回复</span>
                                </label>
                            </div>
                        </div>
                    </div>

                    <div class="settings-card">
                        <h2 class="settings-card-title">引用设置</h2>
                        <div class="settings-grid">
                            <div class="form-group">
                                <label class="form-label">引用方式</label>
                                <select class="form-input" id="setting-reply-quote-mode">
                                    <option value="wechat">微信原生引用</option>
                                    <option value="text">文本引用</option>
                                    <option value="none">不引用</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label class="form-label">引用模板</label>
                                <input type="text" id="setting-reply-quote-template" placeholder="引用：{content}">
                            </div>
                            <div class="form-group">
                                <label class="form-label">引用最大长度</label>
                                <input type="number" id="setting-reply-quote-max-chars" min="0" step="1">
                            </div>
                            <div class="form-group">
                                <label class="form-label">原生引用超时（秒）</label>
                                <input type="number" id="setting-reply-quote-timeout" min="0" step="0.1">
                            </div>
                            <div class="form-group">
                                <label class="form-checkbox" style="display: flex; align-items: center; gap: 12px; cursor: pointer;">
                                    <input type="checkbox" id="setting-reply-quote-fallback">
                                    <span class="form-checkbox-label">原生引用失败时降级文本引用</span>
                                </label>
                            </div>
                        </div>
                    </div>

                    <div class="settings-card">
                        <h2 class="settings-card-title">系统提示</h2>
                        <div class="form-group full-width">
                            <label class="form-label">系统提示词</label>
                            <textarea id="setting-system-prompt" rows="6"></textarea>
                        </div>
                        <div class="form-group full-width">
                            <label class="form-label">会话提示覆盖（每行：会话名|提示词）</label>
                            <textarea id="setting-system-prompt-overrides" rows="4"></textarea>
                        </div>
                    </div>

                    <div class="settings-card">
                        <h2 class="settings-card-title">表情与语音</h2>
                        <div class="settings-grid">
                            <div class="form-group">
                                <label class="form-label">表情策略</label>
                                <select class="form-input" id="setting-emoji-policy">
                                    <option value="wechat">wechat</option>
                                    <option value="strip">strip</option>
                                    <option value="keep">keep</option>
                                    <option value="mixed">mixed</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label class="form-checkbox" style="display: flex; align-items: center; gap: 12px; cursor: pointer;">
                                    <input type="checkbox" id="setting-voice-to-text">
                                    <span class="form-checkbox-label">启用语音转文字</span>
                                </label>
                            </div>
                            <div class="form-group">
                                <label class="form-label">语音转写失败回复</label>
                                <input type="text" id="setting-voice-to-text-fail-reply">
                            </div>
                            <div class="form-group full-width">
                                <label class="form-label">表情替换（每行：原表情=替换表情）</label>
                                <textarea id="setting-emoji-replacements" rows="3"></textarea>
                            </div>
                        </div>
                    </div>

                    <div class="settings-card">
                        <h2 class="settings-card-title">记忆与上下文</h2>
                        <div class="settings-grid">
                            <div class="form-group">
                                <label class="form-label">记忆库路径</label>
                                <input type="text" id="setting-memory-db-path">
                            </div>
                            <div class="form-group">
                                <label class="form-label">上下文条数</label>
                                <input type="number" id="setting-memory-context-limit" min="0" step="1">
                            </div>
                            <div class="form-group">
                                <label class="form-label">记忆过期时间（秒，留空不过期）</label>
                                <input type="number" id="setting-memory-ttl-sec" min="0" step="1">
                            </div>
                            <div class="form-group">
                                <label class="form-label">记忆清理间隔（秒）</label>
                                <input type="number" id="setting-memory-cleanup-interval-sec" min="0" step="0.1">
                            </div>
                            <div class="form-group">
                                <label class="form-checkbox" style="display: flex; align-items: center; gap: 12px; cursor: pointer;">
                                    <input type="checkbox" id="setting-memory-seed-on-first-reply">
                                    <span class="form-checkbox-label">首次回复抓取历史</span>
                                </label>
                            </div>
                            <div class="form-group">
                                <label class="form-label">首次抓取条数</label>
                                <input type="number" id="setting-memory-seed-limit" min="0" step="1">
                            </div>
                            <div class="form-group">
                                <label class="form-label">追加抓取次数</label>
                                <input type="number" id="setting-memory-seed-load-more" min="0" step="1">
                            </div>
                            <div class="form-group">
                                <label class="form-label">追加抓取间隔（秒）</label>
                                <input type="number" id="setting-memory-seed-load-more-interval-sec" min="0" step="0.1">
                            </div>
                            <div class="form-group">
                                <label class="form-checkbox" style="display: flex; align-items: center; gap: 12px; cursor: pointer;">
                                    <input type="checkbox" id="setting-memory-seed-group">
                                    <span class="form-checkbox-label">群聊也抓取历史</span>
                                </label>
                            </div>
                            <div class="form-group">
                                <label class="form-label">上下文轮数</label>
                                <input type="number" id="setting-context-rounds" min="0" step="1">
                            </div>
                            <div class="form-group">
                                <label class="form-label">上下文 token 上限</label>
                                <input type="number" id="setting-context-max-tokens" min="0" step="1">
                            </div>
                            <div class="form-group">
                                <label class="form-label">最大会话数</label>
                                <input type="number" id="setting-history-max-chats" min="0" step="1">
                            </div>
                            <div class="form-group">
                                <label class="form-label">会话过期时间（秒，留空不过期）</label>
                                <input type="number" id="setting-history-ttl-sec" min="0" step="1">
                            </div>
                            <div class="form-group">
                                <label class="form-label">历史日志间隔（秒）</label>
                                <input type="number" id="setting-history-log-interval-sec" min="0" step="1">
                            </div>
                        </div>
                    </div>

                    <div class="settings-card">
                        <h2 class="settings-card-title">轮询与延迟</h2>
                        <div class="settings-grid">
                            <div class="form-group">
                                <label class="form-label">轮询间隔（秒）</label>
                                <input type="number" id="setting-poll-interval-sec" min="0" step="0.01">
                            </div>
                            <div class="form-group">
                                <label class="form-label">轮询最短间隔（秒）</label>
                                <input type="number" id="setting-poll-interval-min-sec" min="0" step="0.01">
                            </div>
                            <div class="form-group">
                                <label class="form-label">轮询最长间隔（秒）</label>
                                <input type="number" id="setting-poll-interval-max-sec" min="0" step="0.01">
                            </div>
                            <div class="form-group">
                                <label class="form-label">退避倍数</label>
                                <input type="number" id="setting-poll-interval-backoff-factor" min="0" step="0.1">
                            </div>
                            <div class="form-group">
                                <label class="form-label">最小回复间隔（秒）</label>
                                <input type="number" id="setting-min-reply-interval-sec" min="0" step="0.01">
                            </div>
                            <div class="form-group">
                                <label class="form-label">随机延迟最小值（秒）</label>
                                <input type="number" id="setting-random-delay-min-sec" min="0" step="0.01">
                            </div>
                            <div class="form-group">
                                <label class="form-label">随机延迟最大值（秒）</label>
                                <input type="number" id="setting-random-delay-max-sec" min="0" step="0.01">
                            </div>
                        </div>
                    </div>

                    <div class="settings-card">
                        <h2 class="settings-card-title">合并与发送</h2>
                        <div class="settings-grid">
                            <div class="form-group">
                                <label class="form-label">合并等待窗口（秒）</label>
                                <input type="number" id="setting-merge-user-messages-sec" min="0" step="0.1">
                            </div>
                            <div class="form-group">
                                <label class="form-label">合并最长等待（秒）</label>
                                <input type="number" id="setting-merge-user-messages-max-wait-sec" min="0" step="0.1">
                            </div>
                            <div class="form-group">
                                <label class="form-label">单条消息最大长度</label>
                                <input type="number" id="setting-reply-chunk-size" min="1" step="1">
                            </div>
                            <div class="form-group">
                                <label class="form-label">分段发送间隔（秒）</label>
                                <input type="number" id="setting-reply-chunk-delay-sec" min="0" step="0.1">
                            </div>
                            <div class="form-group">
                                <label class="form-label">最大并发处理数</label>
                                <input type="number" id="setting-max-concurrency" min="1" step="1">
                            </div>
                        </div>
                    </div>

                    <div class="settings-card">
                        <h2 class="settings-card-title">智能分段</h2>
                        <div class="settings-grid">
                            <div class="form-group">
                                <label class="form-checkbox" style="display: flex; align-items: center; gap: 12px; cursor: pointer;">
                                    <input type="checkbox" id="setting-natural-split-enabled">
                                    <span class="form-checkbox-label">启用智能分段</span>
                                </label>
                            </div>
                            <div class="form-group">
                                <label class="form-label">每段最少字符数</label>
                                <input type="number" id="setting-natural-split-min-chars" min="0" step="1">
                            </div>
                            <div class="form-group">
                                <label class="form-label">每段最多字符数</label>
                                <input type="number" id="setting-natural-split-max-chars" min="0" step="1">
                            </div>
                            <div class="form-group">
                                <label class="form-label">最大分段数</label>
                                <input type="number" id="setting-natural-split-max-segments" min="1" step="1">
                            </div>
                            <div class="form-group">
                                <label class="form-label">段间延迟最小值（秒）</label>
                                <input type="number" id="setting-natural-split-delay-min-sec" min="0" step="0.1">
                            </div>
                            <div class="form-group">
                                <label class="form-label">段间延迟最大值（秒）</label>
                                <input type="number" id="setting-natural-split-delay-max-sec" min="0" step="0.1">
                            </div>
                        </div>
                    </div>

                    <div class="settings-card">
                        <h2 class="settings-card-title">流式回复</h2>
                        <div class="settings-grid">
                            <div class="form-group">
                                <label class="form-label">缓冲阈值（字符）</label>
                                <input type="number" id="setting-stream-buffer-chars" min="0" step="1">
                            </div>
                            <div class="form-group">
                                <label class="form-label">单段最大长度（字符）</label>
                                <input type="number" id="setting-stream-chunk-max-chars" min="0" step="1">
                            </div>
                        </div>
                    </div>

                    <div class="settings-card">
                        <h2 class="settings-card-title">热更新与重连</h2>
                        <div class="settings-grid">
                            <div class="form-group">
                                <label class="form-label">配置热重载间隔（秒）</label>
                                <input type="number" id="setting-config-reload-sec" min="0" step="0.1">
                            </div>
                            <div class="form-group">
                                <label class="form-checkbox" style="display: flex; align-items: center; gap: 12px; cursor: pointer;">
                                    <input type="checkbox" id="setting-reload-ai-client-on-change">
                                    <span class="form-checkbox-label">配置变更重载 AI 客户端</span>
                                </label>
                            </div>
                            <div class="form-group">
                                <label class="form-checkbox" style="display: flex; align-items: center; gap: 12px; cursor: pointer;">
                                    <input type="checkbox" id="setting-reload-ai-client-module">
                                    <span class="form-checkbox-label">重载 ai_client 模块</span>
                                </label>
                            </div>
                            <div class="form-group">
                                <label class="form-label">空闲超时重连阈值（秒）</label>
                                <input type="number" id="setting-keepalive-idle-sec" min="0" step="0.1">
                            </div>
                            <div class="form-group">
                                <label class="form-label">重连最大重试次数</label>
                                <input type="number" id="setting-reconnect-max-retries" min="0" step="1">
                            </div>
                            <div class="form-group">
                                <label class="form-label">重连退避基准（秒）</label>
                                <input type="number" id="setting-reconnect-backoff-sec" min="0" step="0.1">
                            </div>
                            <div class="form-group">
                                <label class="form-label">重连最大等待（秒）</label>
                                <input type="number" id="setting-reconnect-max-delay-sec" min="0" step="0.1">
                            </div>
                        </div>
                    </div>

                    <div class="settings-card">
                        <h2 class="settings-card-title">群聊与发送</h2>
                        <div class="settings-grid">
                            <div class="form-group">
                                <label class="form-checkbox" style="display: flex; align-items: center; gap: 12px; cursor: pointer;">
                                    <input type="checkbox" id="setting-group-include-sender">
                                    <span class="form-checkbox-label">群聊回复包含发送者</span>
                                </label>
                            </div>
                            <div class="form-group">
                                <label class="form-checkbox" style="display: flex; align-items: center; gap: 12px; cursor: pointer;">
                                    <input type="checkbox" id="setting-send-exact-match">
                                    <span class="form-checkbox-label">仅精确匹配会话名发送</span>
                                </label>
                            </div>
                            <div class="form-group">
                                <label class="form-checkbox" style="display: flex; align-items: center; gap: 12px; cursor: pointer;">
                                    <input type="checkbox" id="setting-send-fallback-current-chat">
                                    <span class="form-checkbox-label">发送失败回退当前会话</span>
                                </label>
                            </div>
                        </div>
                    </div>

                    <div class="settings-card">
                        <h2 class="settings-card-title">过滤规则</h2>
                        <div class="settings-grid">
                            <div class="form-group">
                                <label class="form-checkbox" style="display: flex; align-items: center; gap: 12px; cursor: pointer;">
                                    <input type="checkbox" id="setting-filter-mute">
                                    <span class="form-checkbox-label">过滤免打扰/静音会话</span>
                                </label>
                            </div>
                            <div class="form-group">
                                <label class="form-checkbox" style="display: flex; align-items: center; gap: 12px; cursor: pointer;">
                                    <input type="checkbox" id="setting-ignore-official">
                                    <span class="form-checkbox-label">忽略公众号</span>
                                </label>
                            </div>
                            <div class="form-group">
                                <label class="form-checkbox" style="display: flex; align-items: center; gap: 12px; cursor: pointer;">
                                    <input type="checkbox" id="setting-ignore-service">
                                    <span class="form-checkbox-label">忽略服务号</span>
                                </label>
                            </div>
                            <div class="form-group full-width">
                                <label class="form-label">忽略会话名（每行一个）</label>
                                <textarea id="setting-ignore-names" rows="3"></textarea>
                            </div>
                            <div class="form-group full-width">
                                <label class="form-label">忽略关键词（每行一个）</label>
                                <textarea id="setting-ignore-keywords" rows="3"></textarea>
                            </div>
                        </div>
                    </div>

                    <div class="settings-card">
                        <h2 class="settings-card-title">个性化</h2>
                        <div class="settings-grid">
                            <div class="form-group">
                                <label class="form-checkbox" style="display: flex; align-items: center; gap: 12px; cursor: pointer;">
                                    <input type="checkbox" id="setting-personalization-enabled">
                                    <span class="form-checkbox-label">启用个性化功能</span>
                                </label>
                            </div>
                            <div class="form-group">
                                <label class="form-label">画像更新频率（每 N 条）</label>
                                <input type="number" id="setting-profile-update-frequency" min="0" step="1">
                            </div>
                            <div class="form-group">
                                <label class="form-checkbox" style="display: flex; align-items: center; gap: 12px; cursor: pointer;">
                                    <input type="checkbox" id="setting-remember-facts-enabled">
                                    <span class="form-checkbox-label">启用事实记忆</span>
                                </label>
                            </div>
                            <div class="form-group">
                                <label class="form-label">最大事实数量</label>
                                <input type="number" id="setting-max-context-facts" min="0" step="1">
                            </div>
                            <div class="form-group">
                                <label class="form-checkbox" style="display: flex; align-items: center; gap: 12px; cursor: pointer;">
                                    <input type="checkbox" id="setting-profile-inject-in-prompt">
                                    <span class="form-checkbox-label">在提示词注入画像</span>
                                </label>
                            </div>
                        </div>
                    </div>

                    <div class="settings-card">
                        <h2 class="settings-card-title">控制命令</h2>
                        <div class="settings-grid">
                            <div class="form-group">
                                <label class="form-checkbox" style="display: flex; align-items: center; gap: 12px; cursor: pointer;">
                                    <input type="checkbox" id="setting-control-commands-enabled">
                                    <span class="form-checkbox-label">启用控制命令</span>
                                </label>
                            </div>
                            <div class="form-group">
                                <label class="form-label">命令前缀</label>
                                <input type="text" id="setting-control-command-prefix">
                            </div>
                            <div class="form-group">
                                <label class="form-checkbox" style="display: flex; align-items: center; gap: 12px; cursor: pointer;">
                                    <input type="checkbox" id="setting-control-reply-visible">
                                    <span class="form-checkbox-label">控制命令回复可见</span>
                                </label>
                            </div>
                            <div class="form-group full-width">
                                <label class="form-label">允许命令的用户（每行一个）</label>
                                <textarea id="setting-control-allowed-users" rows="3"></textarea>
                            </div>
                        </div>
                    </div>

                    <div class="settings-card">
                        <h2 class="settings-card-title">定时静默</h2>
                        <div class="settings-grid">
                            <div class="form-group">
                                <label class="form-checkbox" style="display: flex; align-items: center; gap: 12px; cursor: pointer;">
                                    <input type="checkbox" id="setting-quiet-hours-enabled">
                                    <span class="form-checkbox-label">启用静默时段</span>
                                </label>
                            </div>
                            <div class="form-group">
                                <label class="form-label">静默开始时间</label>
                                <input type="text" id="setting-quiet-hours-start" placeholder="23:00">
                            </div>
                            <div class="form-group">
                                <label class="form-label">静默结束时间</label>
                                <input type="text" id="setting-quiet-hours-end" placeholder="07:00">
                            </div>
                            <div class="form-group full-width">
                                <label class="form-label">静默自动回复</label>
                                <input type="text" id="setting-quiet-hours-reply">
                            </div>
                        </div>
                    </div>

                    <div class="settings-card">
                        <h2 class="settings-card-title">用量监控</h2>
                        <div class="settings-grid">
                            <div class="form-group">
                                <label class="form-checkbox" style="display: flex; align-items: center; gap: 12px; cursor: pointer;">
                                    <input type="checkbox" id="setting-usage-tracking-enabled">
                                    <span class="form-checkbox-label">启用用量追踪</span>
                                </label>
                            </div>
                            <div class="form-group">
                                <label class="form-label">每日 token 上限</label>
                                <input type="number" id="setting-daily-token-limit" min="0" step="1">
                            </div>
                            <div class="form-group">
                                <label class="form-label">告警阈值（0-1）</label>
                                <input type="number" id="setting-token-warning-threshold" min="0" max="1" step="0.01">
                            </div>
                        </div>
                    </div>

                    <div class="settings-card">
                        <h2 class="settings-card-title">情感识别</h2>
                        <div class="settings-grid">
                            <div class="form-group">
                                <label class="form-checkbox" style="display: flex; align-items: center; gap: 12px; cursor: pointer;">
                                    <input type="checkbox" id="setting-emotion-detection-enabled">
                                    <span class="form-checkbox-label">启用情感识别</span>
                                </label>
                            </div>
                            <div class="form-group">
                                <label class="form-label">检测模式</label>
                                <select class="form-input" id="setting-emotion-detection-mode">
                                    <option value="keywords">keywords</option>
                                    <option value="ai">ai</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label class="form-checkbox" style="display: flex; align-items: center; gap: 12px; cursor: pointer;">
                                    <input type="checkbox" id="setting-emotion-inject-in-prompt">
                                    <span class="form-checkbox-label">注入情绪引导</span>
                                </label>
                            </div>
                            <div class="form-group">
                                <label class="form-checkbox" style="display: flex; align-items: center; gap: 12px; cursor: pointer;">
                                    <input type="checkbox" id="setting-emotion-log-enabled">
                                    <span class="form-checkbox-label">记录情绪日志</span>
                                </label>
                            </div>
                        </div>
                    </div>

                    <div class="settings-card">
                        <h2 class="settings-card-title">日志设置</h2>
                        <div class="settings-grid">
                            <div class="form-group">
                                <label class="form-label">日志级别</label>
                                <select class="form-input" id="setting-log-level">
                                    <option value="DEBUG">DEBUG</option>
                                    <option value="INFO">INFO</option>
                                    <option value="WARNING">WARNING</option>
                                    <option value="ERROR">ERROR</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label class="form-label">日志格式</label>
                                <select class="form-input" id="setting-log-format">
                                    <option value="text">text</option>
                                    <option value="json">json</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label class="form-label">日志文件路径</label>
                                <input type="text" id="setting-log-file">
                            </div>
                            <div class="form-group">
                                <label class="form-label">单文件最大字节</label>
                                <input type="number" id="setting-log-max-bytes" min="1024" step="1024">
                            </div>
                            <div class="form-group">
                                <label class="form-label">保留文件数</label>
                                <input type="number" id="setting-log-backup-count" min="0" step="1">
                            </div>
                            <div class="form-group">
                                <label class="form-checkbox" style="display: flex; align-items: center; gap: 12px; cursor: pointer;">
                                    <input type="checkbox" id="setting-log-message-content">
                                    <span class="form-checkbox-label">记录用户消息内容</span>
                                </label>
                            </div>
                            <div class="form-group">
                                <label class="form-checkbox" style="display: flex; align-items: center; gap: 12px; cursor: pointer;">
                                    <input type="checkbox" id="setting-log-reply-content">
                                    <span class="form-checkbox-label">记录回复内容</span>
                                </label>
                            </div>
                        </div>
                    </div>

                    <div class="settings-card">
                        <h2 class="settings-card-title">关闭行为</h2>
                        <div class="form-group full-width">
                            <div style="font-size: 13px; color: var(--text-secondary); margin-bottom: 8px;">如需重新选择关闭方式，可在此重置</div>
                            <button class="btn btn-secondary btn-sm" id="btn-reset-close-behavior">重置关闭选择</button>
                        </div>
                    </div>

                    <!-- 白名单设置 -->
                    <div class="settings-card">
                        <h2 class="settings-card-title">白名单管理</h2>
                        <div class="form-group full-width">
                            <label class="form-checkbox" style="display: flex; align-items: center; gap: 12px; cursor: pointer;">
                                <input type="checkbox" id="setting-whitelist-enabled">
                                <span class="form-checkbox-label">启用白名单模式（仅回复白名单中的联系人/群）</span>
                            </label>
                        </div>
                        <div class="form-group full-width">
                            <label class="form-label">白名单（每行一个联系人或群名）</label>
                            <textarea id="setting-whitelist" rows="4" placeholder="联系人1&#10;群聊1&#10;..."></textarea>
                        </div>
                    </div>
                </div>

                <!-- 预设编辑模态框 -->
                <div class="modal-overlay" id="preset-modal">
                    <div class="modal">
                        <div class="modal-header">
                            <h3 class="modal-title">编辑预设</h3>
                            <button class="modal-close" id="btn-close-modal">
                                <svg class="icon icon-sm">
                                    <use href="#icon-x" />
                                </svg>
                            </button>
                        </div>
                        <div class="modal-body">
                            <div class="settings-grid" style="grid-template-columns: 1fr;">
                                <input type="hidden" id="edit-preset-original-name">
                                <div class="form-group">
                                    <label class="form-label">预设名称 (ID)</label>
                                    <input type="text" class="form-input" id="edit-preset-name" placeholder="例如: OpenAI">
                                </div>
                                <div class="form-group">
                                    <label class="form-label">模型 (Model)</label>
                                    <select class="form-input" id="edit-preset-model-select">
                                        <option value="">-- 选择模型 --</option>
                                    </select>
                                    <input type="text" class="form-input" id="edit-preset-model-custom" placeholder="输入自定义模型名称"
                                        style="display: none; margin-top: 8px;">
                                </div>
                                <div class="form-group">
                                    <label class="form-label">别名 (Alias)</label>
                                    <input type="text" class="form-input" id="edit-preset-alias" placeholder="例如: 小欧">
                                </div>
                                <div class="form-group">
                                    <label class="form-label">API Key</label>
                                    <div style="display: flex; gap: 8px;">
                                        <input type="password" class="form-input" id="edit-preset-key" style="flex: 1;"
                                            placeholder="输入 API Key">
                                        <button class="btn btn-secondary btn-sm" id="btn-toggle-key" title="显示/隐藏">
                                            <svg class="icon icon-sm">
                                                <use href="#icon-message" />
                                            </svg>
                                        </button>
                                    </div>
                                    <span class="form-label" style="font-size: 11px; margin-top: 4px;">留空则保持原有 Key 不变</span>
                                    <div id="api-key-help" style="font-size: 11px; margin-top: 4px; display: none;">
                                        <a id="api-key-help-link" href="#" target="_blank" style="color: var(--primary-color); text-decoration: none;">获取 API Key &rarr;</a>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="modal-footer">
                            <button class="btn btn-secondary btn-sm" id="btn-cancel-modal">取消</button>
                            <button class="btn btn-primary btn-sm" id="btn-save-modal">确认保存</button>
                        </div>
                    </div>
                </div>

            </section>

            <!-- 日志页面 -->
            <section class="page" id="page-logs">
                <div class="page-header">
                    <h1 class="page-title">系统日志</h1>
                    <div class="page-actions log-actions">
                        <div class="search-wrapper" style="max-width: 260px;">
                            <svg class="icon">
                                <use href="#icon-search" />
                            </svg>
                            <input type="text" class="search-input" placeholder="搜索关键字..." id="log-search">
                        </div>
                        <select class="form-input" id="log-level" style="width: 140px;">
                            <option value="">全部</option>
                            <option value="error">错误</option>
                            <option value="warning">警告</option>
                            <option value="info">信息</option>
                            <option value="send">发送</option>
                            <option value="receive">接收</option>
                        </select>
                        <select class="form-input" id="log-lines" style="width: 140px;">
                            <option value="200">200行</option>
                            <option value="500" selected>500行</option>
                            <option value="1000">1000行</option>
                        </select>
                        <label class="form-checkbox">
                            <input type="checkbox" id="setting-auto-scroll" checked>
                            <span class="form-checkbox-label">自动滚动</span>
                        </label>
                        <label class="form-checkbox">
                            <input type="checkbox" id="setting-auto-refresh" checked>
                            <span class="form-checkbox-label">自动刷新</span>
                        </label>
                        <label class="form-checkbox">
                            <input type="checkbox" id="setting-wrap">
                            <span class="form-checkbox-label">自动换行</span>
                        </label>
                        <button class="btn btn-secondary btn-sm" id="btn-clear-logs">
                            <svg class="icon icon-sm">
                                <use href="#icon-trash" />
                            </svg>
                            <span>清空</span>
                        </button>
                        <button class="btn btn-secondary btn-sm" id="btn-refresh-logs">
                            <svg class="icon icon-sm">
                                <use href="#icon-refresh" />
                            </svg>
                            <span>刷新</span>
                        </button>
                        <button class="btn btn-secondary btn-sm" id="btn-copy-logs">
                            <svg class="icon icon-sm">
                                <use href="#icon-file-text" />
                            </svg>
                            <span>复制</span>
                        </button>
                        <button class="btn btn-secondary btn-sm" id="btn-export-logs">
                            <svg class="icon icon-sm">
                                <use href="#icon-save" />
                            </svg>
                            <span>导出</span>
                        </button>
                    </div>
                </div>

                <div class="log-meta">
                    <div class="log-meta-left">
                        <span class="log-meta-item" id="log-count">0 行</span>
                        <span class="log-meta-sep">·</span>
                        <span class="log-meta-item" id="log-visible-count">0 匹配</span>
                    </div>
                    <div class="log-meta-right">
                        <span class="log-meta-item">上次更新</span>
                        <span class="log-meta-value" id="log-updated">--</span>
                    </div>
                </div>

                <div class="log-container">
                    <pre class="log-content" id="log-content">等待日志加载...</pre>
                </div>
            </section>
        </main>
    </div>

    <div class="modal-overlay" id="close-choice-modal">
        <div class="modal">
            <div class="modal-header">
                <h3 class="modal-title">关闭应用</h3>
            </div>
            <div class="modal-body">
                <div class="form-group full-width">
                    <div style="font-size: 14px; color: var(--text-secondary);">请选择关闭方式</div>
                    <div style="font-size: 12px; color: var(--text-secondary); margin-top: 6px;">当前状态：<span id="close-choice-status">--</span></div>
                </div>
                <div class="form-group full-width" style="margin-top: 8px;">
                    <label class="form-checkbox" style="display: flex; align-items: center; gap: 12px; cursor: pointer;">
                        <input type="checkbox" id="close-choice-remember">
                        <span class="form-checkbox-label">记住我的选择，下次不再提示</span>
                    </label>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary btn-sm" id="btn-close-choice-minimize">最小化到托盘</button>
                <button class="btn btn-primary btn-sm" id="btn-close-choice-quit">彻底关闭</button>
            </div>
        </div>
    </div>

    <!-- Toast 容器 -->
    <div class="toast-container" id="toast-container"></div>

    <!-- 重构后的统一入口（已内置 API 和组件功能）-->
    <script type="module" src="js/app.module.js"></script>
</body>

</html>
